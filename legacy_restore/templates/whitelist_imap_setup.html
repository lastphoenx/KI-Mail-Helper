{% extends "base.html" %}

{% block title %}IMAP Schnell-Setup - Whitelist{% endblock %}

{% block content %}
<div class="container-xxl mt-4 pb-5 mb-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">⚡ IMAP Schnell-Setup</h2>
            <p class="text-muted mb-0">Scanne einen Mail-Account und füge Absender zur Whitelist hinzu <strong>ohne</strong> Mails zu importieren</p>
        </div>
        <div>
            <a href="{{ url_for('whitelist') }}" class="btn btn-outline-secondary">
                🛡️ Zur Whitelist
            </a>
        </div>
    </div>

    <!-- Info Banner -->
    <div class="alert alert-info">
        <div class="d-flex align-items-start gap-3">
            <div style="font-size: 2rem;">💡</div>
            <div>
                <strong>So funktioniert's:</strong>
                <ol class="mb-0 mt-2">
                    <li>Wähle einen Mail-Account aus</li>
                    <li>Scanne die neuesten Mails (nur Header, sehr schnell!)</li>
                    <li>Wähle Absender aus: "Alle", "Top 50" oder einzeln</li>
                    <li>Füge sie zur Whitelist hinzu → UrgencyBooster greift sofort beim nächsten Fetch!</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Step 1: Account-Auswahl -->
    <div class="card border-0 shadow-sm bg-dark text-light mb-4">
        <div class="card-header" style="background: linear-gradient(135deg, #7c3aed, #5b21b6);">
            <h5 class="mb-0 text-light">📧 Schritt 1: Account wählen & scannen</h5>
        </div>
        <div class="card-body">
            {% if mail_accounts|length == 0 %}
            <div class="alert alert-warning">
                ⚠️ Keine Mail-Accounts konfiguriert. 
                <a href="{{ url_for('settings') }}" class="alert-link">Account hinzufügen</a>
            </div>
            {% else %}
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label small text-light mb-2">
                        Mail-Account für Scan:
                    </label>
                    <select class="form-select bg-dark text-light border-secondary" id="scanAccountSelector">
                        <option value="">-- Bitte wählen --</option>
                        {% for account in mail_accounts %}
                        <option value="{{ account.id }}" 
                                data-server="{{ account.decrypted_imap_server or account.imap_server }}"
                                data-username="{{ account.decrypted_imap_username or account.name }}">
                            📧 {{ account.decrypted_imap_username or account.name }}
                            {% if account.decrypted_imap_server %}({{ account.decrypted_imap_server }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label small text-light mb-2">
                        IMAP-Ordner:
                    </label>
                    <select class="form-select bg-dark text-light border-secondary" id="folderInput" disabled>
                        <option value="INBOX">INBOX</option>
                    </select>
                    <small class="text-light opacity-75">Wähle zuerst Account</small>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label small text-light mb-2">
                        Limit:
                    </label>
                    <input type="number" class="form-control bg-dark text-light border-secondary" 
                           id="limitInput" value="1000" min="100" max="5000" placeholder="1000">
                    <small class="text-light opacity-75">Max. 5000</small>
                </div>
            </div>
            
            <div class="mt-3">
                <button type="button" class="btn btn-primary btn-lg w-100" 
                        id="startScanBtn" disabled>
                    <span id="scanBtnIcon">🔍</span> 
                    <span id="scanBtnText">Absender scannen</span>
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Error-Display (hidden by default) -->
    <div id="errorContainer" class="alert alert-danger mb-4" style="display: none;">
        <div class="d-flex justify-content-between align-items-start">
            <div style="flex: 1;">
                <h6 class="mb-2">❌ Fehler beim Scannen</h6>
                <p id="errorMessage" class="mb-0"></p>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" id="retryBtn">
                🔄 Erneut versuchen
            </button>
        </div>
    </div>

    <!-- Limited-Warning (hidden by default) -->
    <div id="limitedWarning" class="alert alert-warning mb-4" style="display: none;">
        <strong>⚠️ Große Mailbox erkannt!</strong><br>
        Der Scan wurde auf die <strong id="limitedScannedCount">1000</strong> neuesten Mails 
        von insgesamt <strong id="limitedTotalCount">0</strong> Mails beschränkt, 
        um Timeouts zu vermeiden. Die häufigsten Absender sollten trotzdem erfasst sein.
    </div>

    <!-- Step 2: Scan-Ergebnisse -->
    <div id="scanResultsContainer" style="display: none;">
        <div class="card border-0 shadow-sm bg-dark text-light">
            <div class="card-header" style="background: linear-gradient(135deg, #0c4a6e, #082f49);">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <h5 class="mb-1 text-light">📋 Schritt 2: Absender auswählen</h5>
                        <small class="text-light opacity-75">
                            <span id="totalSendersText">0</span> eindeutige Absender 
                            aus <span id="totalEmailsText">0</span> Emails
                        </small>
                    </div>
                    <div>
                        <span class="badge bg-info fs-6" id="selectedCountBadge">0 ausgewählt</span>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Bulk-Aktionen -->
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-sm btn-outline-light" id="selectAllBtn">
                            ✅ Alle auswählen
                        </button>
                        <button class="btn btn-sm btn-outline-light" id="deselectAllBtn">
                            ❌ Alle abwählen
                        </button>
                        <button class="btn btn-sm btn-outline-info" id="selectTop50Btn">
                            🔝 Top 50 (häufigste)
                        </button>
                        <button class="btn btn-sm btn-outline-warning" id="selectTop10Btn">
                            ⭐ Top 10
                        </button>
                    </div>
                    
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" 
                               id="accountSpecificToggle" checked>
                        <label class="form-check-label text-light" for="accountSpecificToggle">
                            Nur für diesen Account
                        </label>
                    </div>
                </div>
                
                <!-- Filter -->
                <div class="mb-3">
                    <input type="text" class="form-control bg-dark text-light border-secondary" 
                           id="senderFilterInput" placeholder="🔍 Absender filtern...">
                </div>
                
                <!-- Sender-Liste -->
                <div id="scannedSendersList" class="border border-secondary rounded p-3" 
                     style="max-height: 500px; overflow-y: auto;">
                    <!-- Dynamic content -->
                </div>
                
                <!-- Hinzufügen-Button -->
                <div class="mt-3">
                    <button type="button" class="btn btn-success btn-lg w-100" 
                            id="bulkAddBtn" disabled>
                        ➕ <span id="selectedCountText">0</span> Absender zur Whitelist hinzufügen
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Bulk-Add Result (hidden by default) -->
        <div id="bulkResultContainer" class="mt-4" style="display: none;">
            <div class="card border-0 shadow-sm bg-dark text-light">
                <div class="card-header bg-success">
                    <h5 class="mb-0 text-light">✅ Ergebnis</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-md-6">
                            <div class="display-4 text-success" id="addedCount">0</div>
                            <div class="text-light">✅ Hinzugefügt</div>
                        </div>
                        <div class="col-md-6">
                            <div class="display-4 text-warning" id="skippedCount">0</div>
                            <div class="text-light">⚠️ Übersprungen</div>
                        </div>
                    </div>
                    
                    <div id="skippedDetails" style="display: none;">
                        <h6 class="text-light mb-2">Übersprungene Absender:</h6>
                        <div id="skippedList" class="small" style="max-height: 200px; overflow-y: auto;">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    
                    <div class="mt-3 d-flex gap-2">
                        <a href="{{ url_for('whitelist') }}" class="btn btn-primary">
                            🛡️ Zur Whitelist
                        </a>
                        <button type="button" class="btn btn-outline-light" id="newScanBtn">
                            🔄 Neuer Scan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container für Notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toastContainer"></div>
</div>

<script nonce="{{ csp_nonce() }}">
// ========================================
// IMAP SETUP PAGE JavaScript (Production-Ready)
// ========================================

let scannedData = [];
let selectedSenders = new Set();
let currentAccountId = null;
let isScanning = false;
let cooldownTimer = null;
let cooldownSeconds = 0;

// Helper: Escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper: CSRF Token
function getCsrfToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}

// Helper: Show Toast
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const bgClass = {
        'success': 'bg-success',
        'danger': 'bg-danger',
        'warning': 'bg-warning',
        'info': 'bg-info'
    }[type] || 'bg-info';
    
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white ' + bgClass + ' border-0';
    toast.id = toastId;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = '<div class="d-flex">' +
        '<div class="toast-body">' + escapeHtml(message) + '</div>' +
        '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>' +
        '</div>';
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Load folders when account is selected
document.getElementById('scanAccountSelector')?.addEventListener('change', async function() {
    const accountId = this.value;
    const folderSelect = document.getElementById('folderInput');
    const startBtn = document.getElementById('startScanBtn');
    
    if (!accountId) {
        folderSelect.disabled = true;
        folderSelect.innerHTML = '<option value="INBOX">INBOX</option>';
        startBtn.disabled = true;
        return;
    }
    
    // Load folders for selected account
    folderSelect.disabled = true;
    folderSelect.innerHTML = '<option value="">⏳ Lade Ordner...</option>';
    
    try {
        const response = await fetch('/account/' + accountId + '/folders', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (data.success && data.folders && data.folders.length > 0) {
            folderSelect.innerHTML = data.folders.map(folder => {
                const icon = folder.name === 'INBOX' ? '📥' : 
                            folder.name.toLowerCase().includes('sent') ? '📤' : 
                            folder.name.toLowerCase().includes('trash') ? '🗑️' : 
                            folder.name.toLowerCase().includes('spam') ? '⚠️' : '📁';
                return '<option value="' + escapeHtml(folder.name) + '">' + icon + ' ' + escapeHtml(folder.name) + '</option>';
            }).join('');
            
            // Select INBOX if available
            const inboxOption = data.folders.find(f => f.name === 'INBOX');
            if (inboxOption) {
                folderSelect.value = 'INBOX';
            }
        } else {
            folderSelect.innerHTML = '<option value="INBOX">INBOX</option>';
        }
        
        folderSelect.disabled = false;
        
        // Enable button if folder is selected and no cooldown
        const hasFolder = folderSelect.value && folderSelect.value.trim() !== '';
        startBtn.disabled = !hasFolder || cooldownSeconds > 0 || isScanning;
        
    } catch (error) {
        console.error('Error loading folders:', error);
        folderSelect.innerHTML = '<option value="INBOX">INBOX (Fehler beim Laden)</option>';
        folderSelect.disabled = false;
        
        // Enable button if folder is selected and no cooldown
        const hasFolder = folderSelect.value && folderSelect.value.trim() !== '';
        startBtn.disabled = !hasFolder || cooldownSeconds > 0 || isScanning;
    }
});

// Monitor folder changes
document.getElementById('folderInput')?.addEventListener('change', function() {
    const startBtn = document.getElementById('startScanBtn');
    startBtn.disabled = !this.value || isScanning;
});

// Countdown Timer Function
function startCooldownTimer(seconds) {
    cooldownSeconds = seconds;
    const startBtn = document.getElementById('startScanBtn');
    const btnIcon = document.getElementById('scanBtnIcon');
    const btnText = document.getElementById('scanBtnText');
    
    // Clear existing timer
    if (cooldownTimer) {
        clearInterval(cooldownTimer);
    }
    
    // Update button
    startBtn.disabled = true;
    btnIcon.textContent = '⏱️';
    
    const updateTimer = () => {
        if (cooldownSeconds <= 0) {
            clearInterval(cooldownTimer);
            cooldownTimer = null;
            // Check if account and folder are still selected
            const accountId = document.getElementById('scanAccountSelector')?.value;
            const folder = document.getElementById('folderInput')?.value;
            startBtn.disabled = !accountId || !folder || isScanning;
            btnIcon.textContent = '🔍';
            btnText.textContent = 'Absender scannen';
        } else {
            btnText.textContent = 'Bitte warte ' + cooldownSeconds + 's';
            cooldownSeconds--;
        }
    };
    
    // Initial update
    updateTimer();
    
    // Update every second
    cooldownTimer = setInterval(updateTimer, 1000);
}

// Start Scan
document.getElementById('startScanBtn')?.addEventListener('click', async function() {
    const accountSelector = document.getElementById('scanAccountSelector');
    const folderInput = document.getElementById('folderInput');
    const limitInput = document.getElementById('limitInput');
    
    const accountId = parseInt(accountSelector.value);
    const folder = folderInput.value.trim() || 'INBOX';
    const limit = parseInt(limitInput.value) || 1000;
    
    if (!accountId) {
        showToast('Bitte Account auswählen', 'warning');
        return;
    }
    
    // UI: Scanning State
    isScanning = true;
    this.disabled = true;
    document.getElementById('scanBtnIcon').textContent = '⏳';
    document.getElementById('scanBtnText').textContent = 'Scanne...';
    document.getElementById('errorContainer').style.display = 'none';
    document.getElementById('scanResultsContainer').style.display = 'none';
    document.getElementById('bulkResultContainer').style.display = 'none';
    
    currentAccountId = accountId;
    
    try {
        const response = await fetch('/api/scan-account-senders/' + accountId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ folder, limit })
        });
        
        const data = await response.json();
        
        // Handle 429 Rate Limit
        if (response.status === 429) {
            const secondsRemaining = data.seconds_remaining || 60;
            const errorMsg = 'Rate-Limit erreicht. Bitte warte ' + secondsRemaining + ' Sekunden.';
            
            document.getElementById('errorMessage').textContent = errorMsg;
            document.getElementById('errorContainer').style.display = 'block';
            
            // Start countdown timer
            startCooldownTimer(secondsRemaining);
            
            showToast(errorMsg, 'warning');
            console.warn('⏱️ Rate-Limit:', errorMsg);
            return;
        }
        
        if (!response.ok) {
            throw new Error(data.error || 'HTTP ' + response.status);
        }
        
        if (!data.success) {
            throw new Error(data.error || 'Scan fehlgeschlagen');
        }
        
        // Success!
        scannedData = data.senders || [];
        
        // Load existing whitelist to mark already-added senders
        await loadExistingWhitelist();
        
        // Show limited warning if applicable
        if (data.limited) {
            document.getElementById('limitedScannedCount').textContent = data.scanned_emails;
            document.getElementById('limitedTotalCount').textContent = data.total_emails;
            document.getElementById('limitedWarning').style.display = 'block';
        } else {
            document.getElementById('limitedWarning').style.display = 'none';
        }
        
        // Update stats
        document.getElementById('totalSendersText').textContent = data.total_senders;
        document.getElementById('totalEmailsText').textContent = data.scanned_emails;
        
        // Render senders
        renderSenders();
        
        // Show results
        document.getElementById('scanResultsContainer').style.display = 'block';
        
        // Count new vs already on whitelist
        const alreadyOnWhitelist = scannedData.filter(s => s.onWhitelist).length;
        const newSenders = data.total_senders - alreadyOnWhitelist;
        
        if (alreadyOnWhitelist > 0) {
            showToast('✅ ' + newSenders + ' neue Absender gefunden (' + alreadyOnWhitelist + ' bereits auf Whitelist)', 'success');
        } else {
            showToast('✅ ' + data.total_senders + ' Absender gefunden', 'success');
        }
        
    } catch (error) {
        console.error('❌ Scan error:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorContainer').style.display = 'block';
        showToast('Scan fehlgeschlagen: ' + error.message, 'danger');
    } finally {
        isScanning = false;
        // Only enable if not in cooldown
        if (cooldownSeconds <= 0) {
            this.disabled = false;
            document.getElementById('scanBtnIcon').textContent = '🔍';
            document.getElementById('scanBtnText').textContent = 'Absender scannen';
        }
    }
});

// Retry Button
document.getElementById('retryBtn')?.addEventListener('click', function() {
    document.getElementById('startScanBtn').click();
});

// Load existing whitelist to check which senders are already added
async function loadExistingWhitelist() {
    try {
        const response = await fetch('/api/trusted-senders', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (!response.ok) {
            console.warn('⚠️ Could not load whitelist for comparison');
            return;
        }
        
        const data = await response.json();
        const whitelistPatterns = new Set();
        
        // Collect all patterns from whitelist
        if (data.senders && Array.isArray(data.senders)) {
            data.senders.forEach(sender => {
                whitelistPatterns.add(sender.sender_pattern.toLowerCase());
            });
        }
        
        // Mark scanned senders that are already on whitelist
        scannedData.forEach(sender => {
            const email = sender.email.toLowerCase();
            // Check exact match or domain match
            const atIndex = email.indexOf('@');
            const domain = atIndex > 0 ? email.substring(atIndex) : null; // @domain.com
            const domainOnly = atIndex > 0 ? email.substring(atIndex + 1) : null; // domain.com
            
            sender.onWhitelist = whitelistPatterns.has(email) || 
                                 (domain && whitelistPatterns.has(domain)) ||
                                 (domainOnly && whitelistPatterns.has(domainOnly));
        });
        
        console.log('✅ Whitelist loaded: ' + whitelistPatterns.size + ' patterns');
        
    } catch (error) {
        console.error('Error loading whitelist:', error);
    }
}

// Render Senders List
function renderSenders(filterText = '') {
    const list = document.getElementById('scannedSendersList');
    
    if (!scannedData || scannedData.length === 0) {
        list.innerHTML = '<div class="text-center text-light py-4">' +
            '<div class="mb-2">📭</div>' +
            '<div>Keine Absender gefunden</div>' +
            '</div>';
        return;
    }
    
    // Filter
    const filtered = filterText 
        ? scannedData.filter(s => 
            s.email.toLowerCase().includes(filterText.toLowerCase()) ||
            (s.name && s.name.toLowerCase().includes(filterText.toLowerCase()))
          )
        : scannedData;
    
    if (filtered.length === 0) {
        list.innerHTML = '<div class="text-center text-light py-4">' +
            '<div class="mb-2">🔍</div>' +
            '<div>Keine Ergebnisse für "' + escapeHtml(filterText) + '"</div>' +
            '</div>';
        return;
    }
    
    list.innerHTML = filtered.map((sender, index) => {
        const isSelected = selectedSenders.has(sender.email);
        const onWhitelist = sender.onWhitelist || false;
        const typeIcon = {
            'exact': '🔒',
            'email_domain': '👥',
            'domain': '🏢'
        }[sender.suggested_type] || '🔒';
        
        const typeLabel = {
            'exact': 'Exakt',
            'email_domain': 'Wildcard (@domain)',
            'domain': 'Domain + Subdomains'
        }[sender.suggested_type] || 'Exakt';
        
        // Visual styling for already whitelisted senders
        const whitelistBadge = onWhitelist ? 
            '<span class="badge bg-success ms-1" title="Bereits auf Whitelist">✅ Auf Whitelist</span>' : '';
        const rowOpacity = onWhitelist ? 'opacity: 0.6;' : '';
        
        return '<div class="border-bottom border-secondary p-2 hover-bg-light" ' +
                 'style="transition: background 0.2s; ' + rowOpacity + '" ' +
                 'data-sender-email="' + escapeHtml(sender.email) + '">' +
                '<div class="d-flex align-items-start gap-2">' +
                    '<input type="checkbox" ' +
                           'class="form-check-input mt-1 sender-checkbox" ' +
                           'data-sender-email="' + escapeHtml(sender.email) + '" ' +
                           'data-sender-index="' + index + '" ' +
                           (isSelected ? 'checked' : '') + 
                           (onWhitelist ? ' disabled title="Bereits auf Whitelist"' : '') + '>' +
                    '<div style="flex-grow: 1; min-width: 0;">' +
                        '<div class="d-flex gap-2 align-items-center mb-1 flex-wrap">' +
                            '<select class="form-select form-select-sm sender-type-select" ' +
                                    'style="width: auto; max-width: 200px;" ' +
                                    'data-sender-email="' + escapeHtml(sender.email) + '"' +
                                    (onWhitelist ? ' disabled' : '') + '>' +
                                '<option value="exact" ' + (sender.suggested_type === 'exact' ? 'selected' : '') + '>' +
                                    '🔒 Exakt' +
                                '</option>' +
                                '<option value="email_domain" ' + (sender.suggested_type === 'email_domain' ? 'selected' : '') + '>' +
                                    '👥 Wildcard' +
                                '</option>' +
                                '<option value="domain" ' + (sender.suggested_type === 'domain' ? 'selected' : '') + '>' +
                                    '🏢 Domain + Subs' +
                                '</option>' +
                            '</select>' +
                            '<span class="badge bg-secondary">' + sender.count + ' Mail' + (sender.count !== 1 ? 's' : '') + '</span>' +
                            whitelistBadge +
                        '</div>' +
                        '<div class="font-monospace small mb-1 text-break">' + escapeHtml(sender.email) + '</div>' +
                        (sender.name ? 
                            '<div class="small text-light opacity-75 text-truncate" title="' + escapeHtml(sender.name) + '">' +
                                '👤 ' + escapeHtml(sender.name) +
                            '</div>'
                        : '') +
                    '</div>' +
                '</div>' +
            '</div>';
    }).join('');
    
    // Bind checkbox events
    document.querySelectorAll('.sender-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            const email = this.getAttribute('data-sender-email');
            if (this.checked) {
                selectedSenders.add(email);
            } else {
                selectedSenders.delete(email);
            }
            updateSelectionUI();
        });
    });
}

// Update Selection UI
function updateSelectionUI() {
    const count = selectedSenders.size;
    document.getElementById('selectedCountBadge').textContent = count + ' ausgewählt';
    document.getElementById('selectedCountText').textContent = count;
    document.getElementById('bulkAddBtn').disabled = count === 0;
}

// Filter Input
let filterTimeout = null;
document.getElementById('senderFilterInput')?.addEventListener('input', function() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
        renderSenders(this.value);
    }, 300);
});

// Select All
document.getElementById('selectAllBtn')?.addEventListener('click', function() {
    selectedSenders.clear();
    scannedData.forEach(s => {
        if (!s.onWhitelist) {
            selectedSenders.add(s.email);
        }
    });
    renderSenders(document.getElementById('senderFilterInput').value);
    updateSelectionUI();
});

// Deselect All
document.getElementById('deselectAllBtn')?.addEventListener('click', function() {
    selectedSenders.clear();
    renderSenders(document.getElementById('senderFilterInput').value);
    updateSelectionUI();
});

// Select Top 50
document.getElementById('selectTop50Btn')?.addEventListener('click', function() {
    selectedSenders.clear();
    const available = scannedData.filter(s => !s.onWhitelist);
    available.slice(0, 50).forEach(s => selectedSenders.add(s.email));
    renderSenders(document.getElementById('senderFilterInput').value);
    updateSelectionUI();
    showToast('Top 50 Absender ausgewählt (ohne bereits vorhandene)', 'info');
});

// Select Top 10
document.getElementById('selectTop10Btn')?.addEventListener('click', function() {
    selectedSenders.clear();
    const available = scannedData.filter(s => !s.onWhitelist);
    available.slice(0, 10).forEach(s => selectedSenders.add(s.email));
    renderSenders(document.getElementById('senderFilterInput').value);
    updateSelectionUI();
    showToast('Top 10 Absender ausgewählt (ohne bereits vorhandene)', 'info');
});

// Bulk Add
document.getElementById('bulkAddBtn')?.addEventListener('click', async function() {
    if (selectedSenders.size === 0) {
        showToast('Keine Absender ausgewählt', 'warning');
        return;
    }
    
    const accountSpecific = document.getElementById('accountSpecificToggle').checked;
    const accountId = accountSpecific ? currentAccountId : null;
    
    // Build senders array with current type selection
    const sendersToAdd = [];
    for (const email of selectedSenders) {
        const sender = scannedData.find(s => s.email === email);
        if (!sender) {
            console.warn('⚠️ Sender nicht in scannedData gefunden:', email);
            continue;
        }
        
        // Get current type from select (escape email for selector)
        const escapedEmail = email.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, '\\$&');
        const typeSelect = document.querySelector('.sender-type-select[data-sender-email="' + escapedEmail + '"]');
        const selectedType = typeSelect ? typeSelect.value : sender.suggested_type;
        
        // Generate pattern based on type
        let pattern = email;
        if (selectedType === 'email_domain') {
            // Extract domain: user@domain.com -> @domain.com
            const atIndex = email.indexOf('@');
            if (atIndex > 0) {
                pattern = email.substring(atIndex); // includes the @
            }
        } else if (selectedType === 'domain') {
            // Extract domain: user@domain.com -> domain.com
            const atIndex = email.indexOf('@');
            if (atIndex > 0) {
                pattern = email.substring(atIndex + 1); // without the @
            }
        }
        // else: exact -> keep full email
        
        sendersToAdd.push({
            pattern: pattern,
            type: selectedType,
            label: sender.name || null
        });
    }
    
    console.log('📤 Sende zur Whitelist:', {
        count: sendersToAdd.length,
        account_id: accountId,
        senders: sendersToAdd
    });
    
    // UI: Adding State
    this.disabled = true;
    this.innerHTML = '⏳ Füge hinzu...';
    
    try {
        const response = await fetch('/api/trusted-senders/bulk-add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                senders: sendersToAdd,
                account_id: accountId
            })
        });
        
        const data = await response.json();
        
        console.log('📥 Response vom Server:', data);
        
        if (!response.ok) {
            throw new Error(data.error || 'HTTP ' + response.status);
        }
        
        if (!data.success) {
            throw new Error(data.error || 'Bulk-Add fehlgeschlagen');
        }
        
        // Success! Show result
        console.log('✅ Bulk-Add erfolgreich: ' + data.added + ' hinzugefügt, ' + data.skipped + ' übersprungen');
        
        document.getElementById('addedCount').textContent = data.added;
        document.getElementById('skippedCount').textContent = data.skipped;
        
        // Show skipped details if any
        if (data.skipped > 0 && data.details && data.details.skipped) {
            const skippedList = document.getElementById('skippedList');
            skippedList.innerHTML = data.details.skipped.map(item => 
                '<div class="border-bottom border-secondary p-2">' +
                    '<div class="font-monospace small">' + escapeHtml(item.pattern) + '</div>' +
                    '<div class="small text-warning">⚠️ ' + escapeHtml(item.reason) + '</div>' +
                '</div>'
            ).join('');
            document.getElementById('skippedDetails').style.display = 'block';
        } else {
            document.getElementById('skippedDetails').style.display = 'none';
        }
        
        document.getElementById('bulkResultContainer').style.display = 'block';
        document.getElementById('scanResultsContainer').style.display = 'none';
        
        // Smart toast message
        if (data.added > 0 && data.skipped > 0) {
            showToast('✅ ' + data.added + ' hinzugefügt, ' + data.skipped + ' übersprungen', 'success');
        } else if (data.added > 0) {
            showToast('✅ ' + data.added + ' Absender hinzugefügt!', 'success');
        } else if (data.skipped > 0) {
            showToast('⚠️ ' + data.skipped + ' Absender übersprungen (bereits vorhanden)', 'warning');
        } else {
            showToast('ℹ️ Keine Änderungen vorgenommen', 'info');
        }
        
        // Scroll to result
        document.getElementById('bulkResultContainer').scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('Bulk-Add error:', error);
        showToast('Fehler beim Hinzufügen: ' + error.message, 'danger');
    } finally {
        this.disabled = false;
        this.innerHTML = '➕ <span id="selectedCountText">' + selectedSenders.size + '</span> Absender zur Whitelist hinzufügen';
    }
});

// New Scan Button
document.getElementById('newScanBtn')?.addEventListener('click', function() {
    // Reset state
    scannedData = [];
    selectedSenders.clear();
    document.getElementById('bulkResultContainer').style.display = 'none';
    document.getElementById('scanResultsContainer').style.display = 'none';
    document.getElementById('errorContainer').style.display = 'none';
    document.getElementById('limitedWarning').style.display = 'none';
    document.getElementById('senderFilterInput').value = '';
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

</script>
{% endblock %}
