{% extends "base.html" %}

{% block title %}Recovery-Codes regeneriert - Mail Helper{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="alert alert-success text-center mb-4">
                <h3>✓ Recovery-Codes erfolgreich regeneriert!</h3>
            </div>
            
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title">🔑 Neue Recovery-Codes</h5>
                    <p class="text-muted">
                        Deine alten Recovery-Codes wurden invalidiert. Speichere diese neuen Codes an einem sicheren Ort. 
                        Du kannst sie verwenden wenn du keinen Zugriff auf deine Authenticator-App hast.
                    </p>
                    
                    <div class="alert alert-warning">
                        <strong>⚠️ Wichtig:</strong> Diese Codes werden nur einmal angezeigt. Kopiere sie jetzt!
                    </div>
                    
                    <div class="bg-light p-4 rounded font-monospace border" style="max-height: 400px; overflow-y: auto;">
                        {% for code in recovery_codes %}
                        <div class="py-1">
                            <span class="badge bg-secondary me-2">{{ loop.index }}</span>
                            <strong>{{ code }}</strong>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-outline-primary" onclick="copyToClipboard()">
                            <i class="fas fa-copy"></i> Alle kopieren
                        </button>
                        <button class="btn btn-outline-secondary" onclick="downloadCodes()">
                            <i class="fas fa-download"></i> Als Textdatei herunterladen
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info">
                <strong>💡 Tipp:</strong> Bewahre diese Codes an einem sicheren Ort auf:
                <ul class="mb-0 mt-2">
                    <li>Passwort-Manager (z.B. KeePass, Bitwarden)</li>
                    <li>Verschlüsselte Textdatei auf USB-Stick</li>
                    <li>Ausgedruckt in einem Safe</li>
                </ul>
            </div>
            
            <div class="d-grid gap-2">
                <a href="/settings" class="btn btn-primary">Zurück zu Einstellungen</a>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce() }}">
function copyToClipboard() {
    const codes = [
        {% for code in recovery_codes %}
        "{{ code }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    const text = codes.join('\n');
    
    // Moderne Browser mit Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            showCopyFeedback(true);
        }).catch((err) => {
            console.error('Clipboard API failed:', err);
            fallbackCopy(text);
        });
    } else {
        // Fallback für ältere Browser oder unsichere Kontexte
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    // Temporäres Textarea-Element erstellen
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    
    try {
        const successful = document.execCommand('copy');
        showCopyFeedback(successful);
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showCopyFeedback(false);
    } finally {
        document.body.removeChild(textarea);
    }
}

function showCopyFeedback(success) {
    if (success) {
        // Visuelles Feedback
        const btn = document.querySelector('.btn-outline-primary');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Kopiert!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    } else {
        alert('❌ Kopieren fehlgeschlagen.\n\nBitte markiere die Codes manuell und drücke Strg+C (Windows/Linux) bzw. Cmd+C (Mac).');
    }
}

function downloadCodes() {
    const codes = [
        {% for code in recovery_codes %}
        "{{ code }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    const text = `Mail Helper - Recovery Codes
Generiert am: ${new Date().toLocaleString('de-DE')}
WICHTIG: Bewahre diese Codes sicher auf!

${codes.map((code, i) => `${i+1}. ${code}`).join('\n')}

⚠️ Diese Codes können nur einmal verwendet werden.
Nach Verwendung eines Codes, generiere neue Codes in den Einstellungen.
`;
    
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `recovery-codes-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
