{% extends "base.html" %}

{% block title %}IMAP-Diagnostics - Mail Helper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">üîß IMAP Connection Diagnostics</h4>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Teste die IMAP-Verbindung zu deinen Mail-Accounts. Diagnostics pr√ºft:
                    Verbindung, Authentifizierung, Server-Capabilities, Namespace, Folder-Zugriff, Folder-Listing, Flag-Detection, Server-ID und Extensions.
                </p>

                <!-- Account Selection -->
                <div class="mb-4">
                    <label for="accountSelect" class="form-label"><strong>Mail-Account w√§hlen:</strong></label>
                    <select id="accountSelect" class="form-select" required>
                        <option value="">-- Bitte w√§hlen --</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}">
                            {{ account.name }} ({{ account.decrypted_imap_username or 'Kein Username' }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Phase 15: Folder Selection f√ºr Test 12 (DB Sync Verification) -->
                <div class="mb-4" id="folderSelectionContainer" style="display: none;">
                    <label for="folderSelect" class="form-label">
                        <strong>üìÅ Ordner f√ºr DB Sync-Check w√§hlen (Test 12):</strong>
                    </label>
                    <select id="folderSelect" class="form-select">
                        <option value="">-- Alle Ordner √ºberpr√ºfen --</option>
                        <!-- Wird gef√ºllt nach erfolgreicher Diagnostics (aus folders-Liste) -->
                    </select>
                    <small class="text-muted">
                        Test 12 checkt ob Mails korrekt zwischen DB und IMAP synchronisiert sind.
                        Ordner ausw√§hlen f√ºr spezifischen Test, oder leer lassen f√ºr alle Ordner.
                    </small>
                </div>

                <!-- Test Button -->
                <div class="mb-4">
                    <button id="testBtn" class="btn btn-primary btn-lg" disabled>
                        üß™ Verbindung testen
                    </button>
                    <small class="text-muted ms-2" id="testHint">W√§hle einen Account</small>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="alert alert-info" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <strong>Test l√§uft...</strong>
                    </div>
                </div>

                <!-- Results Container -->
                <div id="resultsContainer" style="display: none;">
                    <hr class="my-4">
                    <h5>üìä Test-Ergebnisse</h5>

                    <!-- Connection Test -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong id="connectionStatus">1Ô∏è‚É£ Verbindung & Authentifizierung</strong>
                        </div>
                        <div class="card-body" id="connectionDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- Capabilities Test -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong id="capabilitiesStatus">2Ô∏è‚É£ Server-Capabilities</strong>
                        </div>
                        <div class="card-body" id="capabilitiesDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- Namespace Test -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong id="namespaceStatus">3Ô∏è‚É£ Namespace & Delimiter</strong>
                        </div>
                        <div class="card-body" id="namespaceDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- Folder Access Test -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong id="folderStatus">4Ô∏è‚É£ Folder-Zugriff (INBOX)</strong>
                        </div>
                        <div class="card-body" id="folderDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- Folder Listing Test -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <strong id="foldersListStatus">5Ô∏è‚É£ Folder-Listing</strong>
                            </div>
                            <div>
                                <button id="toggleSubscribedBtn" class="btn btn-sm btn-light text-dark" style="display: none; padding: 4px 10px; font-size: 0.85em; font-weight: 500; border: 1px solid #ddd;">
                                    üìå Nur abonniert
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="foldersListDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- Flag Detection Test -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong id="flagsStatus">6Ô∏è‚É£ Flag-Detection</strong>
                        </div>
                        <div class="card-body" id="flagsDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- Server ID & Provider Detection -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong id="serverIdStatus">7Ô∏è‚É£ Server-ID & Provider</strong>
                        </div>
                        <div class="card-body" id="serverIdDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- Extensions Support -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong id="extensionsStatus">8Ô∏è‚É£ Extensions Support</strong>
                        </div>
                        <div class="card-body" id="extensionsDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- THREAD Support Test -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong id="threadStatus">9Ô∏è‚É£ THREAD Support</strong>
                        </div>
                        <div class="card-body" id="threadDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- SORT Support Test -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong id="sortStatus">üîü SORT Support</strong>
                        </div>
                        <div class="card-body" id="sortDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- Envelope Parsing Test -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong id="envelopeStatus">1Ô∏è‚É£1Ô∏è‚É£ Envelope Parsing</strong>
                        </div>
                        <div class="card-body" id="envelopeDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- DB Sync Verification Test -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong id="dbSyncStatus">1Ô∏è‚É£2Ô∏è‚É£ DB Sync Verification (Archiv)</strong>
                        </div>
                        <div class="card-body" id="dbSyncDetails">
                            <!-- Wird dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="alert" id="summaryAlert" role="alert">
                        <strong id="summaryTitle">Zusammenfassung</strong>
                        <p class="mb-0" id="summaryText"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce() }}">
    // Account Selection Handler
    document.getElementById('accountSelect').addEventListener('change', function() {
        const testBtn = document.getElementById('testBtn');
        const testHint = document.getElementById('testHint');
        
        if (this.value) {
            testBtn.disabled = false;
            testHint.textContent = 'Bereit zum Testen';
            // Phase 15: Folder-Auswahl anzeigen (wird nach Test gef√ºllt)
            document.getElementById('folderSelectionContainer').style.display = 'none';
        } else {
            testBtn.disabled = true;
            testHint.textContent = 'W√§hle einen Account';
            document.getElementById('folderSelectionContainer').style.display = 'none';
        }
        
        // Hide previous results
        document.getElementById('resultsContainer').style.display = 'none';
    });

    // Test Button Handler
    document.getElementById('testBtn').addEventListener('click', async function() {
        const accountId = document.getElementById('accountSelect').value;
        if (!accountId) return;

        // Show loading
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('resultsContainer').style.display = 'none';
        this.disabled = true;

        try {
            // CSRF Token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

            // Phase 15: Hole ausgew√§hlten Ordner (f√ºr Test 12)
            const folderSelect = document.getElementById('folderSelect');
            const selectedFolder = folderSelect.value || null;  // null = alle Ordner

            // API Call with 150s timeout (max server wait + buffer)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 150000);
            
            const response = await fetch(`/api/imap-diagnostics/${accountId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ folder_name: selectedFolder }),  // Phase 15
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);

            const result = await response.json();

            // Hide loading
            document.getElementById('loadingIndicator').style.display = 'none';

            if (response.ok && result.success) {
                displayResults(result.diagnostics);
            } else {
                displayError(result.error || 'Unbekannter Fehler');
            }
        } catch (error) {
            document.getElementById('loadingIndicator').style.display = 'none';
            if (error.name === 'AbortError') {
                displayError('Timeout: Test-Timeout nach 2.5 Minuten. Server antwortet zu langsam - √ºberpr√ºfen Sie die Netzwerkverbindung.');
            } else {
                displayError('Netzwerkfehler: ' + error.message);
            }
        } finally {
            this.disabled = false;
        }
    });

    // Toggle Subscribed Folders Button Handler
    document.getElementById('toggleSubscribedBtn').addEventListener('click', async function() {
        if (!lastFoldersData) return;
        
        const accountId = document.getElementById('accountSelect').value;
        if (!accountId) return;

        const subscribedOnly = !lastFoldersData.subscribed_only;
        
        // Show loading
        document.getElementById('loadingIndicator').style.display = 'block';
        this.disabled = true;

        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 150000);
            
            const response = await fetch(`/api/imap-diagnostics/${accountId}?subscribed_only=${subscribedOnly}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ subscribed_only: subscribedOnly }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            const result = await response.json();
            document.getElementById('loadingIndicator').style.display = 'none';

            if (response.ok && result.success && result.diagnostics.folders) {
                displayFoldersList(result.diagnostics.folders);
            } else {
                displayFoldersList({ success: false, error: 'Fehler beim Umschalten der Folder-Liste' });
            }
        } catch (error) {
            document.getElementById('loadingIndicator').style.display = 'none';
            displayFoldersList({ success: false, error: 'Network Error: ' + error.message });
        } finally {
            this.disabled = false;
        }
    });

    function displayResults(diagnostics) {
        const container = document.getElementById('resultsContainer');
        container.style.display = 'block';

        // 1. Connection Test
        displayConnectionTest(diagnostics.connection);

        // 2. Capabilities Test
        displayCapabilitiesTest(diagnostics.capabilities);

        // 3. Namespace Test
        displayNamespaceTest(diagnostics.namespace);

        // 4. Folder Access Test
        displayFolderTest(diagnostics.inbox_access);

        // 5. Folder Listing Test
        displayFoldersList(diagnostics.folders);

        // Phase 15: F√ºlle Folder-Select f√ºr Test 12 nach erfolgreichem Folder-Listing
        if (diagnostics.folders && diagnostics.folders.success && diagnostics.folders.folders) {
            populateFolderSelect(diagnostics.folders.folders);
        }

        // 6. Flag Detection Test
        displayFlagsTest(diagnostics.flags);

        // 7. Server ID & Provider
        displayServerIdTest(diagnostics.server_id);

        // 8. Extensions
        displayExtensionsTest(diagnostics.extensions);

        // 9. THREAD Support
        if (diagnostics.thread) {
            displayThreadTest(diagnostics.thread);
        }

        // 10. SORT Support
        if (diagnostics.sort) {
            displaySortTest(diagnostics.sort);
        }

        // 11. Envelope Parsing
        if (diagnostics.envelope) {
            displayEnvelopeTest(diagnostics.envelope);
        }

        // 12. DB Sync Verification
        if (diagnostics.db_sync) {
            displayDbSyncTest(diagnostics.db_sync);
        }

        // Summary
        displaySummary(diagnostics);
    }

    // Phase 15: F√ºlle Folder-Select Dropdown f√ºr Test 12
    function populateFolderSelect(foldersArray) {
        const folderSelect = document.getElementById('folderSelect');
        const folderContainer = document.getElementById('folderSelectionContainer');
        
        // Clear existing options (except "Alle Ordner")
        folderSelect.innerHTML = '<option value="">-- Alle Ordner √ºberpr√ºfen --</option>';
        
        // Add folder options
        if (foldersArray && foldersArray.length > 0) {
            foldersArray.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.name;
                // Phase 15b: folder.count existiert nicht in list_all_folders() Response
                option.textContent = folder.name;  // Nur Ordnername ohne Count
                folderSelect.appendChild(option);
            });
            
            // Show folder selection container
            folderContainer.style.display = 'block';
        } else {
            folderContainer.style.display = 'none';
        }
    }

    // Phase 15: Multi-Folder DB Sync Display
    function displayMultiFolderDbSync(data, statusEl, detailsEl) {
        const allSync = data.folders_with_issues === 0;
        statusEl.innerHTML = allSync ? '1Ô∏è‚É£2Ô∏è‚É£ DB Sync Verification (Multi-Folder) ‚úÖ' : '1Ô∏è‚É£2Ô∏è‚É£ DB Sync Verification (Multi-Folder) ‚ö†Ô∏è';
        
        let html = `
            <div class="alert ${allSync ? 'alert-success' : 'alert-warning'}">
                <strong>${data.summary}</strong><br>
                <small class="text-muted">
                    Gepr√ºft: ${data.total_folders} Ordner | 
                    ${allSync ? '‚úÖ Alle synchronisiert' : `‚ö†Ô∏è ${data.folders_with_issues} mit Issues`}
                </small>
            </div>
        `;
        
        // √úbersichtstabelle mit allen Ordnern
        html += `<h6 class="mt-3">üìä √úbersicht:</h6>`;
        html += `
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Ordner</th>
                            <th>IMAP</th>
                            <th>DB</th>
                            <th>Sync</th>
                            <th>Details</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        let folderIndex = 0;
        for (const [folderName, folderData] of Object.entries(data.folders)) {
            if (!folderData.success) {
                html += `
                    <tr class="table-danger">
                        <td><strong>${folderName}</strong></td>
                        <td colspan="5"><span class="text-danger">‚ùå ${folderData.error || 'Fehler'}</span></td>
                    </tr>
                `;
                continue;
            }
            
            const isSync = folderData.sync_ok;
            const rowClass = isSync ? '' : 'table-warning';
            const syncIcon = isSync ? '‚úÖ' : '‚ö†Ô∏è';
            const hasMails = folderData.all_mails && folderData.all_mails.length > 0;
            
            html += `
                <tr class="${rowClass}">
                    <td><strong>${folderName}</strong></td>
                    <td><span class="badge bg-primary">${folderData.imap_count || 0}</span></td>
                    <td><span class="badge bg-info">${folderData.db_count || 0}</span></td>
                    <td>${syncIcon}</td>
                    <td><small>${folderData.message || '‚Äî'}</small></td>
                    <td>
                        ${hasMails ? `<button class="btn btn-sm btn-outline-primary toggle-folder-details" data-folder-id="folder_${folderIndex}">üìã Details</button>` : '‚Äî'}
                    </td>
                </tr>
            `;
            
            // Phase 15a: Detaillierte Mail-Liste pro Ordner (expandierbar)
            if (hasMails) {
                html += `
                    <tr id="folder_${folderIndex}" class="folder-details" style="display: none;">
                        <td colspan="6" class="bg-light">
                            ${renderFolderMailDetails(folderName, folderData)}
                        </td>
                    </tr>
                `;
            }
            
            folderIndex++;
        }
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        detailsEl.innerHTML = html;
        
        // Phase 15a: Event-Delegation f√ºr toggle-folder-details Buttons (CSP-konform)
        attachFolderDetailsToggleListeners();
    }
    
    // Phase 15a: Attach Event-Listeners f√ºr Folder-Details Toggle (CSP-konform)
    function attachFolderDetailsToggleListeners() {
        // Event-Delegation: Ein Listener f√ºr alle toggle-buttons
        document.querySelectorAll('.toggle-folder-details').forEach(button => {
            button.addEventListener('click', function() {
                const folderId = this.getAttribute('data-folder-id');
                toggleFolderDetails(folderId);
            });
        });
    }
    
    // Phase 15a: Rendere detaillierte Mail-Liste f√ºr einen Ordner
    function renderFolderMailDetails(folderName, folderData) {
        let html = `
            <h6 class="mt-2">üìß Mails in Ordner "${folderName}" (${folderData.all_mails.length}):</h6>
            <div class="table-responsive">
                <table class="table table-sm" style="font-size: 0.85em;">
                    <thead class="table-secondary">
                        <tr>
                            <th rowspan="2">Status</th>
                            <th colspan="2" class="text-center bg-primary text-white">üì° IMAP</th>
                            <th colspan="2" class="text-center bg-info text-white">üíæ DB</th>
                            <th rowspan="2">Betreff</th>
                            <th rowspan="2">üëÅÔ∏è</th>
                            <th rowspan="2">üö©</th>
                            <th rowspan="2">‚Ü©Ô∏è</th>
                            <th rowspan="2">Datum</th>
                        </tr>
                        <tr>
                            <th class="bg-primary text-white">UID</th>
                            <th class="bg-primary text-white">UIDVAL</th>
                            <th class="bg-info text-white">UID</th>
                            <th class="bg-info text-white">UIDVAL</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        folderData.all_mails.forEach(mail => {
            // Status Badge
            let statusBadge = '';
            if (mail.in_imap && mail.in_db) {
                statusBadge = '<span class="badge bg-success">‚úÖ</span>';
            } else if (mail.in_imap && !mail.in_db) {
                statusBadge = '<span class="badge bg-warning">üì°</span>';
            } else if (!mail.in_imap && mail.in_db) {
                statusBadge = '<span class="badge bg-danger">üíæ</span>';
            }
            
            // Phase 15b: Getrennte IMAP/DB Werte
            const imapUid = mail.imap_uid !== null && mail.imap_uid !== undefined ? mail.imap_uid : '‚Äî';
            const imapUidval = mail.imap_uidvalidity !== null && mail.imap_uidvalidity !== undefined ? mail.imap_uidvalidity : '‚Äî';
            const dbUid = mail.db_uid !== null && mail.db_uid !== undefined ? mail.db_uid : '‚Äî';
            const dbUidval = mail.db_uidvalidity !== null && mail.db_uidvalidity !== undefined ? mail.db_uidvalidity : '‚Äî';
            
            // Highlight wenn UID oder UIDVAL unterschiedlich
            let rowClass = '';
            let uidMismatch = false;
            let uidvalMismatch = false;
            
            if (mail.in_imap && mail.in_db) {
                if (mail.imap_uid !== mail.db_uid) {
                    uidMismatch = true;
                    rowClass = 'table-danger';
                }
                if (mail.imap_uidvalidity !== mail.db_uidvalidity) {
                    uidvalMismatch = true;
                    rowClass = 'table-danger';
                }
            }
            
            // Flags
            const seenIcon = mail.is_seen ? '‚úÖ' : '‚Äî';
            const flagIcon = mail.is_flagged ? 'üö©' : '‚Äî';
            const replyIcon = mail.is_answered ? '‚Ü©Ô∏è' : '‚Äî';
            
            // Datum k√ºrzen
            const dateShort = mail.received_at ? mail.received_at.substring(0, 16) : '‚Äî';
            
            // Subject k√ºrzen
            const subjectShort = mail.subject && mail.subject.length > 50 ? mail.subject.substring(0, 47) + '...' : (mail.subject || '(no subject)');
            
            // Styling f√ºr Mismatches
            const uidStyle = uidMismatch ? 'style="background-color: #ffcccc; font-weight: bold;"' : '';
            const uidvalStyle = uidvalMismatch ? 'style="background-color: #ffcccc; font-weight: bold;"' : '';
            
            html += `
                <tr class="${rowClass}">
                    <td>${statusBadge}</td>
                    <td class="bg-light" ${uidStyle}><strong>${imapUid}</strong></td>
                    <td class="bg-light" ${uidvalStyle}><small>${imapUidval}</small></td>
                    <td class="bg-light" ${uidStyle}><strong>${dbUid}</strong></td>
                    <td class="bg-light" ${uidvalStyle}><small>${dbUidval}</small></td>
                    <td title="${mail.subject || ''}">${subjectShort}</td>
                    <td class="text-center">${seenIcon}</td>
                    <td class="text-center">${flagIcon}</td>
                    <td class="text-center">${replyIcon}</td>
                    <td><small>${dateShort}</small></td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
            <small class="text-muted">
                <strong>Legende:</strong>
                <span class="badge bg-success">‚úÖ</span> = IMAP & DB |
                <span class="badge bg-warning">üì°</span> = Nur IMAP |
                <span class="badge bg-danger">üíæ</span> = Nur DB |
                üëÅÔ∏è = Gelesen | üö© = Markiert | ‚Ü©Ô∏è = Beantwortet<br>
                <strong class="text-danger">Rot hinterlegt:</strong> UID oder UIDVALIDITY unterschiedlich zwischen IMAP und DB (Sync-Problem!)
            </small>
        `;
        
        return html;
    }
    
    // Phase 15a: Toggle Folder Details
    function toggleFolderDetails(folderId) {
        const detailsRow = document.getElementById(folderId);
        if (detailsRow) {
            detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
        }
    }

    function displayConnectionTest(data) {
        const statusEl = document.getElementById('connectionStatus');
        const detailsEl = document.getElementById('connectionDetails');

        if (data.success) {
            statusEl.innerHTML = '1Ô∏è‚É£ Verbindung & Authentifizierung ‚úÖ';
            detailsEl.innerHTML = `
                <p class="text-success mb-2"><strong>‚úÖ Verbindung erfolgreich</strong></p>
                <ul class="mb-0">
                    <li>Server: ${data.host}:${data.port}</li>
                    <li>SSL: ${data.ssl ? 'Ja' : 'Nein'}</li>
                    <li>Authentifizierung: Erfolgreich</li>
                </ul>
            `;
        } else {
            statusEl.innerHTML = '1Ô∏è‚É£ Verbindung & Authentifizierung ‚ùå';
            detailsEl.innerHTML = `
                <p class="text-danger mb-2"><strong>‚ùå Verbindung fehlgeschlagen</strong></p>
                <p class="mb-0"><strong>Fehler:</strong> ${data.error}</p>
            `;
        }
    }

    function displayCapabilitiesTest(data) {
        const statusEl = document.getElementById('capabilitiesStatus');
        const detailsEl = document.getElementById('capabilitiesDetails');

        if (data.success) {
            statusEl.innerHTML = '2Ô∏è‚É£ Server-Capabilities ‚úÖ';
            
            const caps = data.capabilities || [];
            const important = ['IDLE', 'NAMESPACE', 'UIDPLUS', 'MOVE', 'ID'];
            
            let html = '<p class="mb-3"><strong>üîπ Wichtige Features:</strong></p><ul class="mb-3">';
            important.forEach(cap => {
                const supported = caps.includes(cap);
                html += `<li>${supported ? '‚úÖ' : '‚ùå'} ${cap}</li>`;
            });
            html += '</ul>';
            
            html += `<p class="mb-2"><strong>üîπ Alle Capabilities (${caps.length} total):</strong></p>`;
            html += '<div style="background-color: #f8f9fa; padding: 12px; border-radius: 4px; font-family: monospace; font-size: 0.9em; line-height: 1.6; word-break: break-word;">';
            html += caps.join(', ');
            html += '</div>';
            
            detailsEl.innerHTML = html;
        } else {
            statusEl.innerHTML = '2Ô∏è‚É£ Server-Capabilities ‚ùå';
            detailsEl.innerHTML = `
                <p class="text-danger mb-0"><strong>Fehler:</strong> ${data.error}</p>
            `;
        }
    }

    function displayNamespaceTest(data) {
        const statusEl = document.getElementById('namespaceStatus');
        const detailsEl = document.getElementById('namespaceDetails');

        if (data.success) {
            statusEl.innerHTML = '3Ô∏è‚É£ Namespace & Delimiter ‚úÖ';
            
            const personal = data.namespace?.personal || 'N/A';
            const delimiter = data.delimiter || '/';
            
            detailsEl.innerHTML = `
                <ul class="mb-0">
                    <li><strong>Personal Namespace:</strong> ${personal}</li>
                    <li><strong>Folder Delimiter:</strong> "${delimiter}"</li>
                </ul>
            `;
        } else {
            statusEl.innerHTML = '3Ô∏è‚É£ Namespace & Delimiter ‚ö†Ô∏è';
            detailsEl.innerHTML = `
                <p class="text-warning mb-0">Server unterst√ºtzt NAMESPACE nicht (nicht kritisch)</p>
            `;
        }
    }

    function displayFolderTest(data) {
        const statusEl = document.getElementById('folderStatus');
        const detailsEl = document.getElementById('folderDetails');

        if (data.success) {
            statusEl.innerHTML = '4Ô∏è‚É£ Folder-Zugriff (INBOX) ‚úÖ';
            
            const exists = data.exists || 0;
            const recent = data.recent || 0;
            const unseen = data.unseen || 0;
            
            detailsEl.innerHTML = `
                <p class="text-success mb-2"><strong>‚úÖ INBOX erfolgreich ge√∂ffnet</strong></p>
                <ul class="mb-0">
                    <li><strong>Emails gesamt:</strong> ${exists}</li>
                    <li><strong>Ungelesen:</strong> ${unseen}</li>
                    <li><strong>Recent:</strong> ${recent}</li>
                </ul>
            `;
        } else {
            statusEl.innerHTML = '4Ô∏è‚É£ Folder-Zugriff (INBOX) ‚ùå';
            detailsEl.innerHTML = `
                <p class="text-danger mb-0"><strong>Fehler:</strong> ${data.error}</p>
            `;
        }
    }

    let lastFoldersData = null;
    
    function displayFoldersList(data) {
        const statusEl = document.getElementById('foldersListStatus');
        const detailsEl = document.getElementById('foldersListDetails');
        const toggleBtn = document.getElementById('toggleSubscribedBtn');
        
        lastFoldersData = data;

        if (data.success && data.folders && data.folders.length > 0) {
            statusEl.innerHTML = `5Ô∏è‚É£ Folder-Listing ‚úÖ`;
            
            const folders = data.folders;
            const isSubscribedOnly = data.subscribed_only || false;
            const listType = data.list_type || 'all';
            
            let html = `<p class="mb-3"><strong>üìÅ ${folders.length} Ordner gefunden (${isSubscribedOnly ? 'nur abonniert' : 'alle'}):</strong></p>`;
            html += '<div style="max-height: 400px; overflow-y: auto;">';
            html += '<table class="table table-sm table-bordered mb-0">';
            html += '<thead class="table-light"><tr><th>Ordner</th><th>Flags</th><th>Special</th></tr></thead><tbody>';
            
            folders.forEach(folder => {
                const name = folder.name || '(unbekannt)';
                const flags = folder.flags && folder.flags.length > 0 ? folder.flags.join(', ') : 'keine';
                
                let special = '';
                if (folder.is_drafts) special += 'üìù ';
                if (folder.is_sent) special += '‚úâÔ∏è ';
                if (folder.is_trash) special += 'üóëÔ∏è ';
                if (folder.is_junk) special += '‚ö†Ô∏è ';
                if (folder.is_archive) special += 'üì¶ ';
                special = special.trim() || '-';
                
                html += `<tr><td style="font-family: monospace; font-size: 0.9em;">${name}</td><td style="font-size: 0.85em;">${flags}</td><td>${special}</td></tr>`;
            });
            
            html += '</tbody></table>';
            html += '</div>';
            
            detailsEl.innerHTML = html;
            toggleBtn.style.display = 'block';
            toggleBtn.textContent = isSubscribedOnly ? 'üì≠ Alle anzeigen' : 'üìå Nur abonniert';
            toggleBtn.className = 'btn btn-sm text-dark ' + (isSubscribedOnly ? 'btn-primary' : 'btn-light');
            if (isSubscribedOnly) {
                toggleBtn.style.borderColor = '#0d6efd';
            } else {
                toggleBtn.style.borderColor = '#ddd';
            }
        } else if (data.success) {
            statusEl.innerHTML = '5Ô∏è‚É£ Folder-Listing ‚ö†Ô∏è';
            detailsEl.innerHTML = '<p class="text-warning mb-0">Keine Ordner gefunden oder leere Liste</p>';
            toggleBtn.style.display = 'none';
        } else {
            statusEl.innerHTML = '5Ô∏è‚É£ Folder-Listing ‚ùå';
            detailsEl.innerHTML = `<p class="text-danger mb-0"><strong>Fehler:</strong> ${data.error}</p>`;
            toggleBtn.style.display = 'none';
        }
    }

    function displayFlagsTest(data) {
        const statusEl = document.getElementById('flagsStatus');
        const detailsEl = document.getElementById('flagsDetails');

        if (data.success) {
            statusEl.innerHTML = '6Ô∏è‚É£ Flag-Detection ‚úÖ';
            
            const stats = data.statistics || {};
            const total = data.total_messages || 0;
            const sample = data.sample_count || 0;
            const flags = data.flags_found || [];
            
            let html = `<p class="text-success mb-2"><strong>‚úÖ Flag-Detection erfolgreich</strong></p>`;
            html += `<div class="row mb-3">`;
            html += `  <div class="col-md-6"><p class="mb-1"><strong>üìä Statistik (${sample} von ${total} Emails):</strong></p>`;
            html += `    <ul class="mb-0" style="font-size: 0.95em;">`;
            html += `      <li>üëÅÔ∏è Gelesen: <strong>${stats.seen || 0}</strong></li>`;
            html += `      <li>üîµ Ungelesen: <strong>${stats.unseen || 0}</strong></li>`;
            html += `      <li>‚≠ê Flagged: <strong>${stats.flagged || 0}</strong></li>`;
            html += `      <li>‚úâÔ∏è Answered: <strong>${stats.answered || 0}</strong></li>`;
            html += `    </ul>`;
            html += `  </div>`;
            html += `  <div class="col-md-6"><p class="mb-1"><strong>üîê UIDVALIDITY pro Ordner:</strong></p>`;
            html += `    <div style="font-size: 0.85em; max-height: 120px; overflow-y: auto;">`;
            if (data.folder_uidvalidities && Object.keys(data.folder_uidvalidities).length > 0) {
                html += `      <table class="table table-sm table-bordered mb-0">`;
                html += `        <thead class="table-light"><tr><th>Ordner</th><th>UIDVALIDITY</th></tr></thead><tbody>`;
                for (const [folder, uidval] of Object.entries(data.folder_uidvalidities)) {
                    html += `        <tr><td><small>${folder}</small></td><td><code>${uidval}</code></td></tr>`;
                }
                html += `      </tbody></table>`;
            } else {
                html += `      <p class="text-muted mb-0"><small>Keine UIDVALIDITY-Daten verf√ºgbar</small></p>`;
            }
            html += `    </div>`;
            html += `  </div>`;
            html += `</div>`;
            html += `<div class="row">`;
            html += `  <div class="col-12"><p class="mb-1"><strong>üè∑Ô∏è Verf√ºgbare Flags (${flags.length}):</strong></p>`;
            html += `    <div style="background-color: #f8f9fa; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 0.85em; max-height: 150px; overflow-y: auto;">`;
            if (flags.length > 0) {
                html += flags.join('<br>');
            } else {
                html += 'Keine Flags gefunden';
            }
            html += `    </div></div>`;
            html += `</div>`;
            
            if (data.sample_messages && data.sample_messages.length > 0) {
                html += `<p class="mb-2"><strong>üìß Sample-Emails (${data.sample_messages.length} von max 50):</strong></p>`;
                html += `<div style="max-height: 400px; overflow-y: auto; font-size: 0.85em;">`;
                html += `<table class="table table-sm table-striped mb-0">`;
                html += `<thead class="table-dark sticky-top"><tr>`;
                html += `  <th style="width: 60px;">UID</th>`;
                html += `  <th style="width: 120px;">Ordner</th>`;
                html += `  <th style="width: 100px;">UIDVALIDITY</th>`;
                html += `  <th style="width: 180px;">Message-ID</th>`;
                html += `  <th>Betreff</th>`;
                html += `  <th style="width: 50px;">Seen</th>`;
                html += `  <th style="width: 50px;">Flag</th>`;
                html += `  <th style="width: 50px;">Reply</th>`;
                html += `</tr></thead><tbody>`;
                data.sample_messages.forEach(msg => {
                    html += `<tr>`;
                    html += `  <td>${msg.uid}</td>`;
                    html += `  <td><small>${msg.folder || 'INBOX'}</small></td>`;
                    html += `  <td><code style="font-size: 0.75em;">${msg.uidvalidity || 'N/A'}</code></td>`;
                    html += `  <td><small style="word-break: break-all;">${msg.message_id || '(keine)'}</small></td>`;
                    html += `  <td><small>${msg.subject || '(kein Betreff)'}</small></td>`;
                    html += `  <td class="text-center">${msg.is_seen ? '‚úÖ' : '‚ùå'}</td>`;
                    html += `  <td class="text-center">${msg.is_flagged ? '‚≠ê' : '‚àí'}</td>`;
                    html += `  <td class="text-center">${msg.is_answered ? '‚úâÔ∏è' : '‚àí'}</td>`;
                    html += `</tr>`;
                });
                html += `</tbody></table>`;
                html += `</div>`;
                html += `<p class="text-muted mt-2 mb-0"><small>üí° Zeigt max 50 Mails aus allen Ordnern (ohne Filterung)</small></p>`;
            }
            
            detailsEl.innerHTML = html;
        } else if (data.total_messages === 0) {
            statusEl.innerHTML = '6Ô∏è‚É£ Flag-Detection ‚ö†Ô∏è';
            detailsEl.innerHTML = '<p class="text-warning mb-0">INBOX ist leer - keine Flags zum Testen</p>';
        } else {
            statusEl.innerHTML = '6Ô∏è‚É£ Flag-Detection ‚ùå';
            detailsEl.innerHTML = `<p class="text-danger mb-0"><strong>Fehler:</strong> ${data.error}</p>`;
        }
    }

    function displayServerIdTest(data) {
        const statusEl = document.getElementById('serverIdStatus');
        const detailsEl = document.getElementById('serverIdDetails');

        if (data.success || data.provider) {
            statusEl.innerHTML = '7Ô∏è‚É£ Server-ID & Provider ‚úÖ';
            
            let html = `<p class="text-success mb-2"><strong>‚úÖ Provider erkannt</strong></p>`;
            html += `<div class="row">`;
            html += `  <div class="col-md-6">`;
            html += `    <p class="mb-2"><strong>üåê Provider:</strong></p>`;
            html += `    <p style="background-color: #e7f3ff; padding: 10px; border-radius: 4px; margin: 0; font-weight: bold;">${data.provider || 'Unbekannt'}</p>`;
            html += `  </div>`;
            
            if (data.server_info && Object.keys(data.server_info).length > 0) {
                html += `  <div class="col-md-6">`;
                html += `    <p class="mb-2"><strong>üìã Server-Info:</strong></p>`;
                html += `    <ul class="mb-0" style="font-size: 0.9em;">`;
                Object.entries(data.server_info).forEach(([key, value]) => {
                    html += `      <li><strong>${key}:</strong> ${value}</li>`;
                });
                html += `    </ul>`;
                html += `  </div>`;
            }
            html += `</div>`;
            
            detailsEl.innerHTML = html;
        } else {
            statusEl.innerHTML = '7Ô∏è‚É£ Server-ID & Provider ‚ö†Ô∏è';
            detailsEl.innerHTML = `<p class="text-warning mb-0">Server unterst√ºtzt ID-Extension nicht (nicht kritisch). Provider: ${data.provider || 'Unbekannt'}</p>`;
        }
    }

    function displayExtensionsTest(data) {
        const statusEl = document.getElementById('extensionsStatus');
        const detailsEl = document.getElementById('extensionsDetails');

        if (data.success && data.extensions) {
            statusEl.innerHTML = '8Ô∏è‚É£ Extensions Support ‚úÖ';
            
            let html = '';
            
            // Server-Antworten f√ºr ENABLE-Commands anzeigen
            if (data.server_responses && data.server_responses.length > 0) {
                html += `<div style="background-color: #f0f8ff; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #0066cc;">`;
                html += `<p class="mb-3" style="font-weight: bold; color: #0066cc;">üì° CAPABILITY Server-Antworten</p>`;
                html += `<p style="font-size: 0.9em; margin-bottom: 12px;">Pr√ºfung ob Extensions verf√ºgbar sind</p>`;
                
                html += `<div style="font-family: monospace; font-size: 0.85em; background-color: #fff; padding: 12px; border-radius: 4px; border: 1px solid #ddd; max-height: 400px; overflow-y: auto;">`;
                
                data.server_responses.forEach((cmd, idx) => {
                    const statusIcon = cmd.status === 'OK' ? '‚úÖ' : (cmd.status === 'NOT_FOUND' ? '‚ùå' : '‚ö†Ô∏è');
                    const statusColor = cmd.status === 'OK' ? '#28a745' : (cmd.status === 'NOT_FOUND' ? '#dc3545' : '#ffc107');
                    
                    html += `<div style="margin-bottom: 10px; padding: 8px; background-color: #fafafa; border-left: 3px solid ${statusColor};">`;
                    html += `<div style="color: ${statusColor}; font-weight: bold; margin-bottom: 4px;">${statusIcon} ${cmd.command}</div>`;
                    html += `<div style="color: #666; font-size: 0.95em; word-break: break-word;">${cmd.response}</div>`;
                    html += `</div>`;
                });
                
                html += `</div></div>`;
            }
            
            // Extensions danach
            const exts = data.extensions || {};
            const totalAvailable = data.total_available || 0;
            const totalEnabled = data.total_enabled || 0;
            
            html += `<p class="text-success mb-3"><strong>‚úÖ ${data.message}</strong></p>`;
            html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">`;
            
            Object.entries(exts).forEach(([extName, extInfo]) => {
                const isAvailable = extInfo.available;
                const isEnabled = extInfo.enabled;
                const statusIcon = isAvailable ? '‚úÖ' : '‚ùå';
                const enabledIcon = isEnabled ? '‚úÖ' : (isAvailable ? '‚ö™' : '‚ùå');
                const bgColor = isEnabled ? '#d4edda' : (isAvailable ? '#fff3cd' : '#f8d7da');
                
                html += `<div style="background-color: ${bgColor}; padding: 10px; border-radius: 4px; font-size: 0.9em; border: 1px solid #ddd;">`;
                html += `  <p class="mb-1"><strong>${extName}</strong></p>`;
                html += `  <p class="mb-1" style="font-size: 0.85em;"><span style="color: #666;">Server:</span> ${statusIcon} | <span style="color: #666;">Aktiviert:</span> ${enabledIcon}</p>`;
                html += `  <p class="mb-0" style="color: #666; font-size: 0.85em;">${extInfo.name}</p>`;
                html += `</div>`;
            });
            
            html += `</div>`;
            detailsEl.innerHTML = html;
        } else {
            statusEl.innerHTML = '8Ô∏è‚É£ Extensions Support ‚ùå';
            detailsEl.innerHTML = `<p class="text-danger mb-0"><strong>Fehler:</strong> ${data.error || 'Unbekannter Fehler'}</p>`;
        }
    }

    function displayThreadTest(data) {
        const statusEl = document.getElementById('threadStatus');
        const detailsEl = document.getElementById('threadDetails');

        if (data.supported) {
            statusEl.innerHTML = `9Ô∏è‚É£ THREAD Support ${data.supported ? '‚úÖ' : '‚ö†Ô∏è'}`;
            let html = `<p class="text-success mb-2"><strong>THREAD Extension unterst√ºtzt</strong></p>`;
            html += `<ul>`;
            
            if (data.algorithms && data.algorithms.length > 0) {
                html += `<li><strong>Unterst√ºtzte Algorithmen:</strong> ${data.algorithms.join(', ')}</li>`;
            }
            
            if (data.thread_results && data.thread_results.thread_count !== undefined) {
                html += `<li><strong>Threads gefunden:</strong> ${data.thread_results.thread_count}</li>`;
                html += `<li><strong>Nachrichten in Threads:</strong> ${data.thread_results.total_messages_in_threads}</li>`;
                html += `<li><strong>Gr√∂√üter Thread:</strong> ${data.thread_results.largest_thread} Nachrichten</li>`;
                
                if (data.thread_results.average_messages_per_thread !== undefined) {
                    html += `<li><strong>‚åÄ Pro Thread:</strong> ${data.thread_results.average_messages_per_thread} Nachrichten</li>`;
                }
                
                if (data.thread_results.oldest_date && data.thread_results.newest_date) {
                    html += `<li><strong>üìÖ Zeitspanne:</strong> ${data.thread_results.oldest_date} bis ${data.thread_results.newest_date}</li>`;
                }
            }
            
            // Sample threads with collapsible details
            if (data.thread_results && data.thread_results.sample_threads && data.thread_results.sample_threads.length > 0) {
                html += `</ul><p class="mt-3 mb-2"><strong>üì¶ Sample Threads:</strong></p>`;
                html += `<div style="margin-left: 15px;">`;
                
                data.thread_results.sample_threads.forEach((thread, idx) => {
                    const id = 'thread-sample-' + idx;
                    html += `<div style="margin-bottom: 10px; border-left: 2px solid #0066cc; padding-left: 10px;">`;
                    html += `<button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#${id}" aria-expanded="false">
                        Thread ${thread.thread_num}: ${thread.size} Nachrichten
                    </button>`;
                    html += `<div class="collapse mt-2" id="${id}">`;
                    
                    if (thread.messages) {
                        thread.messages.forEach((msg, msgIdx) => {
                            html += `<div style="font-size: 0.9em; margin: 5px 0; padding: 5px; background: #f9f9f9; border-radius: 3px;">`;
                            html += `[${msgIdx + 1}] ${msg.date || '?'}: <em>${msg.subject || '(kein Betreff)'}</em>`;
                            html += `</div>`;
                        });
                    }
                    
                    if (thread.oldest && thread.newest) {
                        html += `<p style="font-size: 0.85em; color: #666; margin-top: 5px; margin-bottom: 0;">
                            üïê ${thread.oldest} - ${thread.newest}
                        </p>`;
                    }
                    
                    html += `</div></div>`;
                });
                
                html += `</div>`;
            } else {
                html += `</ul>`;
            }
            
            detailsEl.innerHTML = html;
        } else {
            statusEl.innerHTML = '9Ô∏è‚É£ THREAD Support ‚ö†Ô∏è';
            detailsEl.innerHTML = `<p class="text-warning mb-0"><strong>Nicht unterst√ºtzt:</strong> Server unterst√ºtzt THREAD Extension nicht (optional)</p>`;
        }
    }

    function displaySortTest(data) {
        const statusEl = document.getElementById('sortStatus');
        const detailsEl = document.getElementById('sortDetails');

        if (data.supported) {
            statusEl.innerHTML = `üîü SORT Support ${data.working_criteria > 0 ? '‚úÖ' : '‚ö†Ô∏è'}`;
            let html = `<p class="text-success mb-2"><strong>SORT Extension unterst√ºtzt</strong></p>`;
            html += `<ul>`;
            
            if (data.charsets && data.charsets.length > 0) {
                html += `<li><strong>Unterst√ºtzte Zeichens√§tze:</strong> ${data.charsets.join(', ')}</li>`;
            }
            
            html += `<li><strong>Funktionsf√§hige Sortierkriterien:</strong> ${data.working_criteria}/${Object.keys(data.sort_results || {}).length}</li>`;
            
            if (data.sort_results) {
                html += `<li><strong>Getestete Kriterien:</strong>`;
                html += `<ul style="margin-top: 8px;">`;
                
                Object.entries(data.sort_results).forEach(([criteria, result]) => {
                    const icon = result.success ? '‚úÖ' : '‚ùå';
                    html += `<li>${icon} ${result.label} (${criteria})</li>`;
                });
                
                html += `</ul></li>`;
            }
            
            html += `</ul>`;
            detailsEl.innerHTML = html;
        } else {
            statusEl.innerHTML = 'üîü SORT Support ‚ö†Ô∏è';
            detailsEl.innerHTML = `<p class="text-warning mb-0"><strong>Nicht unterst√ºtzt:</strong> Server unterst√ºtzt SORT Extension nicht (optional)</p>`;
        }
    }

    function displayEnvelopeTest(data) {
        const statusEl = document.getElementById('envelopeStatus');
        const detailsEl = document.getElementById('envelopeDetails');

        if (data.success && data.sample_count > 0) {
            statusEl.innerHTML = '1Ô∏è‚É£1Ô∏è‚É£ Envelope Parsing ‚úÖ';
            let html = `<p class="text-success mb-2"><strong>Envelope Parsing erfolgreich</strong></p>`;
            html += `<p class="mb-3"><strong>üìä ${data.sample_count} Nachrichten analysiert (von ${data.total_messages} gesamt):</strong></p>`;
            
            if (data.envelopes && data.envelopes.length > 0) {
                html += `<div style="max-height: 400px; overflow-y: auto;">`;
                
                data.envelopes.forEach((env, idx) => {
                    const replyIndicator = env.is_reply ? '‚Ü©Ô∏è' : 'üì®';
                    const positionStr = env.position ? `${env.position}/${env.total_samples}` : `${idx + 1}`;
                    
                    html += `<div style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px;">`;
                    html += `<p class="mb-2"><strong>Email ${idx + 1} ${replyIndicator}</strong> (UID: ${env.uid}, Position: ${positionStr})</p>`;
                    
                    if (env.date) {
                        html += `<p class="mb-1"><strong>üìÖ Datum:</strong> ${env.date}</p>`;
                    }
                    
                    html += `<p class="mb-1"><strong>üìù Betreff:</strong> ${env.subject}</p>`;
                    
                    if (env.from && env.from.length > 0) {
                        html += `<p class="mb-1"><strong>üë§ Von:</strong> ${env.from.join(', ')}</p>`;
                    }
                    
                    if (env.to && env.to.length > 0) {
                        html += `<p class="mb-1"><strong>üìÆ An:</strong> ${env.to.join(', ')}</p>`;
                    }
                    
                    if (env.cc && env.cc.length > 0) {
                        html += `<p class="mb-1"><strong>üìã CC:</strong> ${env.cc.join(', ')}</p>`;
                    }
                    
                    if (env.message_id) {
                        html += `<p class="mb-1" style="font-size: 0.85em;"><strong>üîó Message-ID:</strong> <code>${env.message_id}</code></p>`;
                    }
                    
                    if (env.in_reply_to) {
                        html += `<p class="mb-1" style="font-size: 0.85em;"><strong>‚Ü©Ô∏è In-Reply-To:</strong> <code>${env.in_reply_to}</code></p>`;
                    } else if (env.is_reply === false) {
                        html += `<p class="mb-1" style="font-size: 0.85em; color: #28a745;"><strong>‚úâÔ∏è Root-Message:</strong> (Keine Antwort auf andere Email)</p>`;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            }
            
            detailsEl.innerHTML = html;
        } else if (data.success) {
            statusEl.innerHTML = '1Ô∏è‚É£1Ô∏è‚É£ Envelope Parsing ‚ö†Ô∏è';
            detailsEl.innerHTML = `<p class="text-warning mb-0"><strong>Keine Mails gefunden:</strong> INBOX ist leer oder nicht zug√§nglich</p>`;
        } else {
            statusEl.innerHTML = '1Ô∏è‚É£1Ô∏è‚É£ Envelope Parsing ‚ùå';
            detailsEl.innerHTML = `<p class="text-danger mb-0"><strong>Fehler:</strong> ${data.error || 'Unbekannter Fehler'}</p>`;
        }
    }
    function displayDbSyncTest(data) {
        const statusEl = document.getElementById('dbSyncStatus');
        const detailsEl = document.getElementById('dbSyncDetails');

        if (data.success) {
            // Phase 15: Multi-Folder Mode?
            if (data.multi_folder_mode && data.folders) {
                displayMultiFolderDbSync(data, statusEl, detailsEl);
                return;
            }
            
            // Single-Folder Mode (wie bisher)
            const isSync = data.sync_ok;
            statusEl.innerHTML = isSync ? '1Ô∏è‚É£2Ô∏è‚É£ DB Sync Verification ‚úÖ' : '1Ô∏è‚É£2Ô∏è‚É£ DB Sync Verification ‚ö†Ô∏è';
            
            let html = `
                <div class="alert ${isSync ? 'alert-success' : 'alert-warning'}">
                    <strong>${isSync ? '‚úÖ Perfekt synchronisiert!' : '‚ö†Ô∏è Synchronisations-Unterschiede gefunden'}</strong><br>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <span class="badge bg-primary">üì° IMAP: ${data.imap_count}</span>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-info">üíæ DB: ${data.db_count}</span>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-success">‚úÖ Beide: ${data.in_both}</span>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-warning">‚ö†Ô∏è Diff: ${data.only_imap + data.only_db}</span>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.test_mail_found) {
                html += `
                    <div class="alert ${data.test_mail_synced ? 'alert-success' : 'alert-danger'}">
                        <strong>üéØ Test-Mail (UID ${data.test_mail_uid}):</strong>
                        ${data.test_mail_in_db ? '‚úÖ Korrekt in DB synchronisiert' : '‚ùå NICHT in DB gefunden!'}
                        ${!data.test_mail_in_db ? '<br><small class="text-muted">Hinweis: Mail k√∂nnte mit alter UIDVALIDITY in DB sein (rot markiert in Tabelle)</small>' : ''}
                    </div>
                `;
            }
            
            // TABELLE mit ALLEN Mails
            if (data.all_mails && data.all_mails.length > 0) {
                html += `
                    <h6 class="mt-3">üìä Alle Mails (${data.all_mails.length}):</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" style="font-size: 0.85em;">
                            <thead class="table-light">
                                <tr>
                                    <th>Status</th>
                                    <th>Herkunft</th>
                                    <th>Ordner</th>
                                    <th>UID</th>
                                    <th>UIDVAL</th>
                                    <th>Betreff</th>
                                    <th>Message-ID</th>
                                    <th>üëÅÔ∏è</th>
                                    <th>üö©</th>
                                    <th>‚Ü©Ô∏è</th>
                                    <th>Datum</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.all_mails.forEach(mail => {
                    // Status Badge
                    let statusBadge = '';
                    let herkunft = '';
                    if (mail.in_imap && mail.in_db) {
                        statusBadge = '<span class="badge bg-success">‚úÖ</span>';
                        herkunft = '<small><strong class="text-success">IMAP + DB</strong></small>';
                    } else if (mail.in_imap && !mail.in_db) {
                        statusBadge = '<span class="badge bg-warning">üì°</span>';
                        herkunft = '<small><strong class="text-warning">Nur IMAP</strong></small>';
                    } else if (!mail.in_imap && mail.in_db) {
                        statusBadge = '<span class="badge bg-danger">üíæ</span>';
                        herkunft = '<small><strong class="text-danger">Nur DB</strong></small>';
                    }
                    
                    // Highlight Test-Mail ODER unterschiedliche UIDVALIDITY
                    let rowClass = '';
                    if (data.test_mail_uid === mail.uid) {
                        rowClass = 'table-warning';
                    } else if (mail.uidvalidity && mail.uidvalidity !== data.uidvalidity) {
                        rowClass = 'table-danger';  // Alte UIDVALIDITY = Mail aus altem State
                    }
                    
                    // Flags
                    const seenIcon = mail.is_seen ? '‚úÖ' : '‚Äî';
                    const flagIcon = mail.is_flagged ? 'üö©' : '‚Äî';
                    const replyIcon = mail.is_answered ? '‚Ü©Ô∏è' : '‚Äî';
                    
                    // Datum k√ºrzen
                    const dateShort = mail.received_at ? mail.received_at.substring(0, 16) : '‚Äî';
                    
                    // Subject k√ºrzen
                    const subjectShort = mail.subject.length > 50 ? mail.subject.substring(0, 47) + '...' : mail.subject;
                    
                    // Message-ID k√ºrzen
                    const msgIdShort = mail.message_id.length > 30 ? mail.message_id.substring(0, 27) + '...' : mail.message_id;
                    
                    // UIDVALIDITY Warning
                    let uidvalDisplay = mail.uidvalidity || '‚Äî';
                    if (mail.uidvalidity && mail.uidvalidity !== data.uidvalidity) {
                        uidvalDisplay = `<span class="text-danger" title="Alte UIDVALIDITY! Ordner wurde invalidiert.">${mail.uidvalidity} ‚ö†Ô∏è</span>`;
                    }
                    
                    html += `
                        <tr class="${rowClass}">
                            <td>${statusBadge}</td>
                            <td>${herkunft}</td>
                            <td><small><strong>${mail.folder || 'Archiv'}</strong></small></td>
                            <td><strong>${mail.uid}</strong></td>
                            <td><small>${uidvalDisplay}</small></td>
                            <td title="${mail.subject}">${subjectShort}</td>
                            <td><small><code title="${mail.message_id}">${msgIdShort}</code></small></td>
                            <td class="text-center">${seenIcon}</td>
                            <td class="text-center">${flagIcon}</td>
                            <td class="text-center">${replyIcon}</td>
                            <td><small>${dateShort}</small></td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Legende
                html += `
                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>Legende:</strong>
                            <span class="badge bg-success">‚úÖ</span> = In IMAP & DB |
                            <span class="badge bg-warning">üì°</span> = Nur auf Server |
                            <span class="badge bg-danger">üíæ</span> = Nur in DB |
                            üëÅÔ∏è = Gelesen | üö© = Markiert | ‚Ü©Ô∏è = Beantwortet<br>
                            <strong class="text-danger">Rot hinterlegt:</strong> Alte UIDVALIDITY (Ordner wurde invalidiert, Mail sollte neu gefetcht werden)
                        </small>
                    </div>
                `;
            }
            
            detailsEl.innerHTML = html;
        } else {
            statusEl.innerHTML = '1Ô∏è‚É£2Ô∏è‚É£ DB Sync Verification ‚ö†Ô∏è';
            detailsEl.innerHTML = `<p class="text-muted">${data.message || 'Skipped (no DB access)'}</p>`;
        }
    }
    function displaySummary(diagnostics) {
        const alertEl = document.getElementById('summaryAlert');
        const titleEl = document.getElementById('summaryTitle');
        const textEl = document.getElementById('summaryText');

        const tests = [
            diagnostics.connection?.success,
            diagnostics.capabilities?.success,
            diagnostics.namespace?.success,
            diagnostics.inbox_access?.success,
            diagnostics.folders?.success,
            diagnostics.flags?.success,
            diagnostics.extensions?.success
        ];
        
        // Server ID is optional, don't count in overall success

        const passedCount = tests.filter(t => t === true).length;
        const totalCount = tests.length;

        if (passedCount === totalCount) {
            alertEl.className = 'alert alert-success';
            titleEl.textContent = '‚úÖ Alle Tests bestanden!';
            textEl.textContent = 'Die IMAP-Verbindung funktioniert einwandfrei.';
        } else if (passedCount >= totalCount - 1) {
            alertEl.className = 'alert alert-warning';
            titleEl.textContent = '‚ö†Ô∏è Tests gr√∂√ütenteils erfolgreich';
            textEl.textContent = `${passedCount}/${totalCount} Tests bestanden. Kleinere Probleme erkannt.`;
        } else {
            alertEl.className = 'alert alert-danger';
            titleEl.textContent = '‚ùå Tests fehlgeschlagen';
            textEl.textContent = `Nur ${passedCount}/${totalCount} Tests bestanden. Bitte Einstellungen pr√ºfen.`;
        }
    }

    function displayError(errorMsg) {
        const container = document.getElementById('resultsContainer');
        container.style.display = 'block';
        
        container.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <h5 class="alert-heading">‚ùå Fehler</h5>
                <p class="mb-0">${errorMsg}</p>
            </div>
        `;
    }
</script>
{% endblock %}
