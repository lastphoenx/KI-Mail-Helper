{% extends "base.html" %}

{% block title %}Antwort-Stile - KI-Mail-Helper{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-5xl">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 mb-8 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-bold mb-2">✍️ Antwort-Stile</h1>
                <p class="text-blue-100 text-lg">Passe an, wie deine Antwort-Entwürfe generiert werden</p>
            </div>
            <a href="{{ url_for('settings') }}" class="btn btn-ghost text-white hover:bg-blue-700">
                <i class="fas fa-arrow-left mr-2"></i> Zurück
            </a>
        </div>
    </div>
    
    <!-- Globale Einstellungen -->
    <div class="card bg-blue-50 border-2 border-blue-200 mb-6 shadow-lg">
        <div class="card-body">
            <h2 class="card-title text-blue-800 text-xl">
                🌍 Globale Einstellungen
                <span class="badge badge-info">Wirken auf alle Stile</span>
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <!-- Anrede-Form -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Anrede-Form</span>
                    </label>
                    <select id="global-address-form" class="select select-bordered w-full">
                        <option value="auto">🔄 Automatisch (aus Email erkennen)</option>
                        <option value="du">👋 Du (informell)</option>
                        <option value="sie">🎩 Sie (formell)</option>
                    </select>
                </div>
                
                <!-- Standard-Anrede -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Standard-Anrede</span>
                    </label>
                    <input type="text" id="global-salutation" 
                           class="input input-bordered w-full"
                           placeholder="z.B. Liebe/r, Hallo, Guten Tag">
                    <label class="label">
                        <span class="label-text-alt">Leer = KI entscheidet</span>
                    </label>
                </div>
                
                <!-- Grussformel -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Grussformel</span>
                    </label>
                    <input type="text" id="global-closing" 
                           class="input input-bordered w-full"
                           placeholder="z.B. Beste Grüsse, Viele Grüsse">
                    <label class="label">
                        <span class="label-text-alt">Leer = KI entscheidet</span>
                    </label>
                </div>
                
                <!-- Signatur -->
                <div class="form-control md:col-span-2">
                    <label class="label">
                        <span class="label-text font-medium">📝 Signatur-Einstellungen</span>
                    </label>
                    <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                        <label class="label cursor-pointer justify-start gap-3 mb-3">
                            <input type="checkbox" id="global-signature-enabled" 
                                   class="checkbox checkbox-primary checkbox-lg">
                            <span class="label-text font-semibold text-base">Signatur anhängen</span>
                        </label>
                        <textarea id="global-signature-text" 
                                  class="textarea textarea-bordered w-full h-20 font-mono text-sm"
                                  placeholder="z.B. Mike\nTechnischer Support\nFirma GmbH\n+41 79 123 45 67"></textarea>
                        <label class="label">
                            <span class="label-text-alt text-gray-500">💡 Tipp: Mehrzeilige Signaturen mit Enter-Taste</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Zusätzliche Anweisungen -->
            <div class="form-control mt-6">
                <label class="label">
                    <span class="label-text font-semibold text-base flex items-center gap-2">
                        <span class="text-2xl">🤖</span> Zusätzliche Anweisungen für die KI
                    </span>
                </label>
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-4">
                    <textarea id="global-custom-instructions" 
                              class="textarea textarea-bordered w-full h-28 bg-white text-sm"
                              placeholder="Beispiele:\n• In unserer Firma ist es üblich, dass wir uns duzen\n• Wir verwenden nie Emojis in geschäftlichen Mails\n• Immer kurz und prägnant formulieren\n• Bei Ablehnungen immer eine Alternative anbieten"></textarea>
                    <p class="text-xs text-gray-600 mt-2">
                        💡 Diese Anweisungen gelten für alle Antwort-Stile und werden mit den spezifischen Stil-Vorgaben kombiniert.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stil-Tabs -->
    <div class="card shadow-lg">
        <div class="card-body">
            <h2 class="card-title text-xl mb-4">
                🎨 Stil-spezifische Einstellungen
                <span class="badge badge-ghost">Optional - überschreibt Global</span>
            </h2>
            
            <!-- Tab-Buttons -->
            <div class="mb-6">
                <div class="flex flex-wrap gap-3 bg-gradient-to-r from-gray-100 to-gray-50 p-4 rounded-lg shadow-sm">
                    <button class="tab-btn tab-active px-6 py-3 rounded-lg font-semibold text-base transition-all duration-200 cursor-pointer border-2" data-style="formal">
                        📜 Formell
                    </button>
                    <button class="tab-btn px-6 py-3 rounded-lg font-semibold text-base transition-all duration-200 cursor-pointer border-2" data-style="friendly">
                        😊 Freundlich
                    </button>
                    <button class="tab-btn px-6 py-3 rounded-lg font-semibold text-base transition-all duration-200 cursor-pointer border-2" data-style="brief">
                        ⚡ Kurz
                    </button>
                    <button class="tab-btn px-6 py-3 rounded-lg font-semibold text-base transition-all duration-200 cursor-pointer border-2" data-style="decline">
                        ❌ Ablehnung
                    </button>
                </div>
            </div>
            
            <style nonce="{{ csp_nonce() }}">
                .tab-btn {
                    background: white;
                    color: #4b5563;
                    border-color: #e5e7eb;
                }
                .tab-btn:hover {
                    border-color: #3b82f6;
                    color: #1e40af;
                    transform: translateY(-2px);
                    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
                }
                .tab-btn.tab-active {
                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                    color: white;
                    border-color: #2563eb;
                    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
                }
            </style>
            
            <!-- Tab-Content (wird per JS gefüllt) -->
            <div id="style-tab-content">
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Lade Einstellungen...</p>
                </div>
            </div>
            
            <!-- Vorschau -->
            <div class="divider text-lg font-semibold">Vorschau</div>
            
            <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-lg p-6 border-2 border-gray-200">
                <div class="flex items-center justify-between mb-3">
                    <span class="font-semibold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-eye text-blue-600"></i>
                        So sieht eine Antwort aus:
                    </span>
                    <button id="refresh-preview-btn" class="btn btn-sm btn-ghost">
                        <i class="fas fa-sync-alt mr-1"></i> Aktualisieren
                    </button>
                </div>
                <pre id="preview-text" class="whitespace-pre-wrap text-sm bg-white p-4 rounded border shadow-sm font-mono">
Lade Vorschau...
                </pre>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="flex justify-between items-center mt-8 gap-4">
        <button id="reset-defaults-btn" class="btn btn-info btn-lg">
            <i class="fas fa-undo mr-2"></i> Auf Standard zurücksetzen
        </button>
        <button id="save-all-btn" class="btn btn-success btn-lg">
            <i class="fas fa-save mr-2"></i> Alle Änderungen speichern
        </button>
    </div>
    
</div>

<script nonce="{{ csp_nonce() }}">
// CSRF Token Helper
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content || '';
}

// State
let currentStyle = 'formal';
let settings = {};
let unsavedChanges = false;

// Load on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadSettings();
    switchTab('formal');
    
    // Attach event listeners to global form fields
    document.getElementById('global-address-form').addEventListener('change', updateGlobal);
    document.getElementById('global-salutation').addEventListener('change', updateGlobal);
    document.getElementById('global-closing').addEventListener('change', updateGlobal);
    document.getElementById('global-signature-enabled').addEventListener('change', updateGlobal);
    document.getElementById('global-signature-text').addEventListener('change', updateGlobal);
    document.getElementById('global-custom-instructions').addEventListener('change', updateGlobal);
    
    // Attach event listeners to tab buttons
    document.querySelectorAll('.tab-btn').forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            const style = tab.dataset.style;
            if (style) switchTab(style);
        });
    });
    
    // Attach event listeners to action buttons
    document.getElementById('refresh-preview-btn').addEventListener('click', refreshPreview);
    document.getElementById('save-all-btn').addEventListener('click', saveAllSettings);
    document.getElementById('reset-defaults-btn').addEventListener('click', resetToDefaults);
});

async function loadSettings() {
    try {
        const response = await fetch('/api/reply-styles');
        if (!response.ok) throw new Error('Failed to load settings');
        settings = await response.json();
        populateGlobalForm();
    } catch (error) {
        console.error('Error loading settings:', error);
        showToast('Fehler beim Laden der Einstellungen', 'error');
    }
}

function populateGlobalForm() {
    const global = settings.global || {};
    document.getElementById('global-address-form').value = global.address_form || 'auto';
    document.getElementById('global-salutation').value = global.salutation || '';
    document.getElementById('global-closing').value = global.closing || '';
    document.getElementById('global-signature-enabled').checked = global.signature_enabled || false;
    document.getElementById('global-signature-text').value = global.signature_text || '';
    document.getElementById('global-custom-instructions').value = global.custom_instructions || '';
}

function switchTab(styleKey) {
    currentStyle = styleKey;
    
    // Update tab styling with enhanced visual feedback
    document.querySelectorAll('.tab-btn').forEach(tab => {
        tab.classList.remove('tab-active');
        if (tab.dataset.style === styleKey) {
            tab.classList.add('tab-active');
        }
    });
    
    // Render tab content
    renderStyleTab(styleKey);
    refreshPreview();
}

function renderStyleTab(styleKey) {
    const style = settings[styleKey] || {};
    const global = settings.global || {};
    
    const html = `
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r-lg shadow-sm">
            <div class="flex items-start gap-3">
                <i class="fas fa-info-circle text-blue-600 text-xl mt-1"></i>
                <div>
                    <p class="font-semibold text-blue-900">Leere Felder übernehmen die globalen Einstellungen</p>
                    <p class="text-sm text-blue-700 mt-1">Fülle nur die Felder aus, die für diesen Stil anders sein sollen.</p>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">Anrede-Form</span>
                    <span class="label-text-alt text-gray-500">Global: ${global.address_form || 'auto'}</span>
                </label>
                <select id="style-address-form" class="select select-bordered w-full">
                    <option value="">— Von Global übernehmen —</option>
                    <option value="auto" ${style.address_form === 'auto' ? 'selected' : ''}>🔄 Automatisch</option>
                    <option value="du" ${style.address_form === 'du' ? 'selected' : ''}>👋 Du</option>
                    <option value="sie" ${style.address_form === 'sie' ? 'selected' : ''}>🎩 Sie</option>
                </select>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">Anrede</span>
                    <span class="label-text-alt text-gray-500">Global: ${global.salutation || '(KI entscheidet)'}</span>
                </label>
                <input type="text" id="style-salutation" 
                       class="input input-bordered w-full"
                       placeholder="Von Global übernehmen"
                       value="${style.salutation || ''}">
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-medium">Grussformel</span>
                    <span class="label-text-alt text-gray-500">Global: ${global.closing || '(KI entscheidet)'}</span>
                </label>
                <input type="text" id="style-closing" 
                       class="input input-bordered w-full"
                       placeholder="Von Global übernehmen"
                       value="${style.closing || ''}">
            </div>
            
            <div class="form-control md:col-span-2">
                <label class="label">
                    <span class="label-text font-semibold flex items-center gap-2">
                        <span class="text-xl">💬</span> Zusätzliche Anweisungen für diesen Stil
                    </span>
                </label>
                <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-lg p-3">
                    <textarea id="style-custom-instructions" 
                              class="textarea textarea-bordered w-full h-24 bg-white text-sm"
                              placeholder="z.B. Bei Ablehnungen immer eine Alternative anbieten, bei formellen Mails immer Titel verwenden">${style.custom_instructions || ''}</textarea>
                    <p class="text-xs text-gray-600 mt-2">💡 Diese Anweisungen ergänzen die globalen Anweisungen speziell für diesen Stil.</p>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end mt-6">
            <button id="reset-style-btn" data-style="${styleKey}" class="btn btn-warning">
                <i class="fas fa-trash mr-1"></i> Überschreibungen löschen (auf Global zurück)
            </button>
        </div>
    `;
    
    document.getElementById('style-tab-content').innerHTML = html;
    
    // Attach event listeners to dynamically created elements
    const addressForm = document.getElementById('style-address-form');
    const salutation = document.getElementById('style-salutation');
    const closing = document.getElementById('style-closing');
    const customInstr = document.getElementById('style-custom-instructions');
    const resetBtn = document.getElementById('reset-style-btn');
    
    if (addressForm) addressForm.addEventListener('change', markUnsaved);
    if (salutation) salutation.addEventListener('change', markUnsaved);
    if (closing) closing.addEventListener('change', markUnsaved);
    if (customInstr) customInstr.addEventListener('change', markUnsaved);
    if (resetBtn) resetBtn.addEventListener('click', () => resetStyleToGlobal(styleKey));
}

async function refreshPreview() {
    try {
        const response = await fetch('/api/reply-styles/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                style_key: currentStyle,
                sample_sender: 'Max Mustermann <max@example.com>'
            })
        });
        
        if (!response.ok) throw new Error('Preview failed');
        const data = await response.json();
        document.getElementById('preview-text').textContent = data.preview_text;
    } catch (error) {
        console.error('Preview error:', error);
        document.getElementById('preview-text').textContent = 'Fehler beim Laden der Vorschau';
    }
}

function markUnsaved() {
    unsavedChanges = true;
}

function updateGlobal() {
    markUnsaved();
    // Speichere in lokalem State
    settings.global = {
        address_form: document.getElementById('global-address-form').value,
        salutation: document.getElementById('global-salutation').value || null,
        closing: document.getElementById('global-closing').value || null,
        signature_enabled: document.getElementById('global-signature-enabled').checked,
        signature_text: document.getElementById('global-signature-text').value || null,
        custom_instructions: document.getElementById('global-custom-instructions').value || null,
    };
    refreshPreview();
}

async function saveAllSettings() {
    const saveBtn = event.target;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Speichere...';
    
    try {
        // Global speichern
        const globalResponse = await fetch('/api/reply-styles/global', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(settings.global)
        });
        
        if (!globalResponse.ok) throw new Error('Failed to save global settings');
        
        // Aktuellen Stil speichern (falls geändert)
        const styleData = {
            address_form: document.getElementById('style-address-form')?.value || null,
            salutation: document.getElementById('style-salutation')?.value || null,
            closing: document.getElementById('style-closing')?.value || null,
            custom_instructions: document.getElementById('style-custom-instructions')?.value || null,
        };
        
        // Nur speichern wenn mindestens ein Wert gesetzt
        if (Object.values(styleData).some(v => v)) {
            const styleResponse = await fetch(`/api/reply-styles/${currentStyle}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(styleData)
            });
            
            if (!styleResponse.ok) throw new Error('Failed to save style settings');
        }
        
        unsavedChanges = false;
        showToast('✅ Einstellungen gespeichert!', 'success');
        
    } catch (error) {
        console.error('Save error:', error);
        showToast('❌ Fehler beim Speichern', 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Alle Änderungen speichern';
    }
}

async function resetStyleToGlobal(styleKey) {
    if (!confirm(`Alle Überschreibungen für "${styleKey}" löschen und auf Global zurücksetzen?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/reply-styles/${styleKey}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (!response.ok) throw new Error('Delete failed');
        
        delete settings[styleKey];
        renderStyleTab(styleKey);
        refreshPreview();
        showToast('✅ Auf Global zurückgesetzt', 'success');
    } catch (error) {
        console.error('Reset error:', error);
        showToast('❌ Fehler beim Zurücksetzen', 'error');
    }
}

async function resetToDefaults() {
    if (!confirm('Alle Einstellungen auf Standard zurücksetzen?\n\nDies löscht alle deine Anpassungen!')) {
        return;
    }
    
    try {
        // Alle Stile löschen
        for (const style of ['formal', 'friendly', 'brief', 'decline']) {
            await fetch(`/api/reply-styles/${style}`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': getCsrfToken() }
            });
        }
        
        // Global auf leer setzen (Defaults greifen)
        await fetch('/api/reply-styles/global', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                address_form: 'auto',
                salutation: null,
                closing: null,
                signature_enabled: false,
                signature_text: null,
                custom_instructions: null
            })
        });
        
        await loadSettings();
        switchTab(currentStyle);
        showToast('✅ Auf Standard zurückgesetzt', 'success');
    } catch (error) {
        console.error('Reset error:', error);
        showToast('❌ Fehler beim Zurücksetzen', 'error');
    }
}

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', (e) => {
    if (unsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Toast function (if not already defined in base.html)
function showToast(message, type = 'info') {
    // If you have a toast system in base.html, use it
    // Otherwise simple alert:
    if (type === 'error') {
        alert(message);
    } else {
        console.log(message);
        // You can also create a toast element dynamically here
    }
}
</script>

{% endblock %}
