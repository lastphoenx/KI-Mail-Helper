{% extends "base.html" %}

{% block title %}E-Mail Liste - Mail Helper{% endblock %}

{% block content %}
<!-- CSS f√ºr erledigte Emails (global) -->
<style nonce="{{ csp_nonce() }}">
    /* Erledigte Emails ausgegraut -->
    li:has(form[action*="/undo"]) {
        opacity: 0.65;
        background: linear-gradient(to right, #f8f9fa 0%, #e9ecef 100%) !important;
    }
    li:has(form[action*="/undo"]) .email-subject {
        text-decoration: line-through;
        color: #6c757d !important;
    }
    li:has(form[action*="/undo"]) .badge {
        opacity: 0.7;
    }
</style>

<div class="mb-5 pb-5">
<h1 class="mb-4">üìù E-Mail Liste</h1>

<!-- Filter Bar (Phase 13) -->
<div class="card mb-4" id="filterBar">
    <div class="card-body">
        <!-- Hauptfilter-Leiste (kompakt) -->
        <div class="filter-toolbar mb-3">
            <div class="row g-2 align-items-end">
                <!-- Account -->
                <div class="col-auto">
                    <label class="form-label small mb-1">üìß Account</label>
                    <select class="form-select form-select-sm filter-select" data-filter="mail_account" id="accountSelect">
                        <option value="">Alle</option>
                        {% if user_accounts %}
                            {% for account in user_accounts %}
                            <option value="{{ account.id }}" {% if account.id|string == filter_account_id|string %}selected{% endif %}>
                                {{ account.decrypted_imap_username or account.name }}
                            </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <!-- Folder -->
                <div class="col-auto">
                    <label class="form-label small mb-1">üìÅ Ordner</label>
                    <select class="form-select form-select-sm filter-select" data-filter="folder" id="folderSelect" 
                            {% if not server_folders %}disabled{% endif %}>
                        <option value="">{% if server_folders %}Alle Ordner{% else %}Erst Account w√§hlen{% endif %}</option>
                        {% if server_folders %}
                            {% for folder in server_folders %}
                            <option value="{{ folder }}" {% if folder == filter_folder %}selected{% endif %}>
                                {{ folder }}
                            </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <!-- Status (Read/Unread) -->
                <div class="col-auto">
                    <label class="form-label small mb-1">üëÅÔ∏è Status</label>
                    <select class="form-select form-select-sm filter-select" data-filter="seen">
                        <option value="">Alle</option>
                        <option value="true" {% if filter_seen == 'true' %}selected{% endif %}>Gelesen</option>
                        <option value="false" {% if filter_seen == 'false' %}selected{% endif %}>Ungelesen</option>
                    </select>
                </div>

                <!-- Flagged -->
                <div class="col-auto">
                    <label class="form-label small mb-1">üö© Wichtig</label>
                    <select class="form-select form-select-sm filter-select" data-filter="flagged">
                        <option value="">Alle</option>
                        <option value="true" {% if filter_flagged == 'true' %}selected{% endif %}>Geflaggt</option>
                        <option value="false" {% if filter_flagged == 'false' %}selected{% endif %}>Nicht geflaggt</option>
                    </select>
                </div>

                <!-- Attachments -->
                <div class="col-auto">
                    <label class="form-label small mb-1">üìé Anh√§nge</label>
                    <select class="form-select form-select-sm filter-select" data-filter="attach">
                        <option value="">Alle</option>
                        <option value="true" {% if filter_attachments == 'true' %}selected{% endif %}>Mit Anhang</option>
                        <option value="false" {% if filter_attachments == 'false' %}selected{% endif %}>Ohne Anhang</option>
                    </select>
                </div>

                <!-- Kalendereinladungen -->
                <div class="col-auto">
                    <label class="form-label small mb-1">üìÖ Termine</label>
                    <select class="form-select form-select-sm filter-select" data-filter="calendar">
                        <option value="">Alle</option>
                        <option value="true" {% if filter_calendar == 'true' %}selected{% endif %}>Nur Termine</option>
                        <option value="false" {% if filter_calendar == 'false' %}selected{% endif %}>Keine Termine</option>
                    </select>
                </div>

                <!-- More/Advanced Toggle -->
                <div class="col-auto ms-auto d-flex gap-2">
                    <a href="/list" class="btn btn-sm btn-outline-danger" id="resetFiltersBtn" title="Alle Filter zur√ºcksetzen">
                        üîÑ Reset
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="advancedToggle" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                        ‚öôÔ∏è Erweitert
                    </button>
                </div>
            </div>

            <!-- Erweiterte Filter (zusammengeklappt) -->
            <div class="collapse mt-3" id="advancedFilters">
                <div class="row g-2 align-items-end">
                    <!-- Suche -->
                    <div class="col-md-3">
                        <label class="form-label small mb-1">üîç Suche</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control form-control-sm filter-search" placeholder="Betreff, Absender..." 
                                   value="{{ search_term }}" id="searchInput">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" 
                                    aria-expanded="false" id="searchModeBtn" title="Suchmodus">
                                <span id="searchModeLabel">Text</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item search-mode-option" href="#" data-mode="text">
                                    <i class="bi bi-search"></i> Text-Suche
                                </a></li>
                                <li><a class="dropdown-item search-mode-option" href="#" data-mode="semantic">
                                    <i class="bi bi-lightbulb"></i> Semantisch
                                </a></li>
                            </ul>
                        </div>
                        <small class="text-muted" id="searchModeHint" style="display:none;">
                            üß† Findet √§hnliche Bedeutungen
                        </small>
                    </div>

                    <!-- Datums-Range -->
                    <div class="col-md-2">
                        <label class="form-label small mb-1">üìÖ Von</label>
                        <input type="date" class="form-control form-control-sm filter-select" data-filter="date_from" 
                               value="{{ filter_date_from }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small mb-1">üìÖ Bis</label>
                        <input type="date" class="form-control form-control-sm filter-select" data-filter="date_to" 
                               value="{{ filter_date_to }}">
                    </div>

                    <!-- Priorit√§t (Legacy) -->
                    <div class="col-md-2">
                        <label class="form-label small mb-1">üéØ Priorit√§t</label>
                        <select class="form-select form-select-sm filter-select" data-filter="farbe">
                            <option value="">Alle</option>
                            <option value="rot" {% if filter_color == 'rot' %}selected{% endif %}>üî¥ Rot</option>
                            <option value="gelb" {% if filter_color == 'gelb' %}selected{% endif %}>üü° Gelb</option>
                            <option value="gr√ºn" {% if filter_color == 'gr√ºn' %}selected{% endif %}>üü¢ Gr√ºn</option>
                        </select>
                    </div>

<!-- Status (Done) -->
                    <div class="col-md-2">
                        <label class="form-label small mb-1">‚úì Bearbeitet</label>
                        <select class="form-select form-select-sm filter-select" data-filter="done">
                            <option value="">Alle</option>
                            <option value="false" {% if filter_done == 'false' %}selected{% endif %}>Offen</option>
                            <option value="true" {% if filter_done == 'true' %}selected{% endif %}>Erledigt</option>
                        </select>
                    </div>

                    <!-- Tags -->
                    <div class="col-md-2">
                        <label class="form-label small mb-1">üè∑Ô∏è Tags</label>
                        <select class="form-select form-select-sm filter-select" data-filter="tags">
                            <option value="">Alle Tags</option>
                            {% if all_tags %}
                                {% for tag in all_tags %}
                                <option value="{{ tag.id }}" {% if filter_tag_ids and tag.id == filter_tag_ids[0] %}selected{% endif %}>
                                    {{ tag.name }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sortierung & Info -->
        <div class="row align-items-center pt-2 border-top">
            <div class="col-auto">
                <small class="text-muted">
                    <strong id="resultCount">{{ mails|length }}</strong> Mails
                    <span id="activeFilters" class="badge bg-info ms-2" style="display:none;"></span>
                </small>
            </div>
            <div class="col-auto ms-auto">
                <label class="form-label small mb-0 me-2">Sortierung:</label>
                <select class="form-select form-select-sm d-inline-block" style="width: auto;" id="sortBy" data-filter="sort">
                    <option value="score" {% if sort_by == 'score' %}selected{% endif %}>Score</option>
                    <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Datum</option>
                    <option value="size" {% if sort_by == 'size' %}selected{% endif %}>Gr√∂√üe</option>
                    <option value="sender" {% if sort_by == 'sender' %}selected{% endif %}>Absender</option>
                </select>
                <button class="btn btn-sm btn-outline-secondary ms-2" id="sortOrder" data-order="{{ sort_order }}">
                    {% if sort_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- TOP Pagination Info & Per-Page Selection -->
{% if total_pages >= 1 %}
<div class="d-flex justify-content-between align-items-center mb-3" id="topPaginationBar">
    <div class="d-flex align-items-center">
        <span class="text-muted">
            <strong>{{ total_count }}</strong> E-Mails insgesamt
            {% if total_pages > 1 %}
            &mdash; Seite <strong>{{ page }}</strong> von <strong>{{ total_pages }}</strong>
            {% endif %}
        </span>
    </div>
    <div class="d-flex align-items-center gap-3">
        <label class="form-label small mb-0 me-1">Pro Seite:</label>
        <select class="form-select form-select-sm" style="width: auto;" id="perPageSelect" data-filter="per_page">
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            <option value="150" {% if per_page == 150 %}selected{% endif %}>150</option>
        </select>
        {% if total_pages > 1 %}
        <!-- Quick Navigation -->
        <nav aria-label="Top pagination">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ page - 1 }}{% if filter_account_id %}&mail_account={{ filter_account_id }}{% endif %}{% if filter_folder %}&folder={{ filter_folder }}{% endif %}{% if filter_seen %}&seen={{ filter_seen }}{% endif %}{% if filter_flagged %}&flagged={{ filter_flagged }}{% endif %}{% if filter_attachments %}&attach={{ filter_attachments }}{% endif %}{% if filter_tag_ids %}&tags={{ filter_tag_ids|join(',') }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if per_page != 50 %}&per_page={{ per_page }}{% endif %}" 
                       {% if page <= 1 %}tabindex="-1" aria-disabled="true"{% endif %}>
                        &laquo;
                    </a>
                </li>
                <li class="page-item disabled"><span class="page-link">{{ page }}/{{ total_pages }}</span></li>
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ page + 1 }}{% if filter_account_id %}&mail_account={{ filter_account_id }}{% endif %}{% if filter_folder %}&folder={{ filter_folder }}{% endif %}{% if filter_seen %}&seen={{ filter_seen }}{% endif %}{% if filter_flagged %}&flagged={{ filter_flagged }}{% endif %}{% if filter_attachments %}&attach={{ filter_attachments }}{% endif %}{% if filter_tag_ids %}&tags={{ filter_tag_ids|join(',') }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if per_page != 50 %}&per_page={{ per_page }}{% endif %}" 
                       {% if page >= total_pages %}tabindex="-1" aria-disabled="true"{% endif %}>
                        &raquo;
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- E-Mail-Liste -->
<div class="card" id="emailListCard">
    <div class="card-header">
        <strong id="emailListCount">{{ mails|length }}</strong> Mails
        {% if sort_by != 'score' or sort_order == 'asc' %}
        <small class="text-muted">(sortiert nach {{ sort_by|replace('score', 'Score')|replace('date', 'Datum')|replace('size', 'Gr√∂√üe')|replace('sender', 'Absender') }} {{ 'aufsteigend' if sort_order == 'asc' else 'absteigend' }})</small>
        {% else %}
        <small class="text-muted">(sortiert nach Score)</small>
        {% endif %}
    </div>
    <ul class="list-group list-group-flush">
        {% for email in mails|default([]) %}
        {% set raw = email.raw_email %}
        {% set tag_list = email._decrypted_tags.split(',') if email._decrypted_tags else [] %}
        <li class="list-group-item">
            <div class="row align-items-center">
                <div class="col-md-1 text-center">
                    {# Score-Anzeige: Immer email.score verwenden (wird bei Korrektur aktualisiert) #}
                    {% if email.optimization_status == 'done' and email.optimize_score is not none and email.optimization_completed_at and email.processed_at and email.optimization_completed_at > email.processed_at %}
                    <span class="badge priority-{{ email.optimize_farbe }} fs-5">
                        {{ email.optimize_score }}
                    </span>
                    {% else %}
                    <span class="badge priority-{{ email.farbe }} fs-5">
                        {{ email.score }}
                    </span>
                    {% endif %}
                </div>
                <div class="col-md-8">
                    <h6 class="mb-1">
                        {% if raw and raw.is_calendar_invite %}
                            {% if raw.calendar_method == 'REPLY' %}
                                <span class="badge bg-success me-1" title="Terminantwort (Zusage/Absage)" style="font-size: 0.75em;">‚úÖ Antwort</span>
                            {% elif raw.calendar_method == 'CANCEL' %}
                                <span class="badge bg-danger me-1" title="Terminabsage" style="font-size: 0.75em;">‚ùå Absage</span>
                            {% else %}
                                <span class="badge bg-primary me-1" title="Termineinladung" style="font-size: 0.75em;">üìÖ Termin</span>
                            {% endif %}
                        {% endif %}
                        <a href="/email/{{ email.raw_email_id }}" class="text-decoration-none">
                            {{ email._decrypted_subject|default("(ohne Betreff)") }}
                        </a>
                        {% if raw and raw.attachments|length > 0 %}
                        <span class="text-muted ms-2" title="{{ raw.attachments|length }} Anhang{% if raw.attachments|length > 1 %}e{% endif %}">üìé {{ raw.attachments|length }}</span>
                        {% endif %}
                    </h6>
                    <small class="text-muted">
                        Von: {{ email._decrypted_sender|default("Unbekannt") }}
                        {% if raw and raw.received_at %}| {{ raw.received_at }}{% endif %}
                    </small>
                    <p class="mb-2 mt-2">{{ email._decrypted_summary_de|default('Keine Zusammenfassung verf√ºgbar')|truncate(200) }}</p>
                    <div class="small text-muted mb-2">
                        {% if email.user_override_dringlichkeit is not none or email.user_override_wichtigkeit is not none %}
                        {# User-Korrektur hat h√∂chste Priorit√§t #}
                        <span class="badge bg-warning text-dark me-1">‚úèÔ∏è Korrigiert</span>
                        Dringlichkeit: {{ email.user_override_dringlichkeit if email.user_override_dringlichkeit is not none else email.dringlichkeit }} | 
                        Wichtigkeit: {{ email.user_override_wichtigkeit if email.user_override_wichtigkeit is not none else email.wichtigkeit }} |
                        Aktion: {{ (email.user_override_kategorie if email.user_override_kategorie else email.kategorie_aktion)|replace('_',' ') }}
                        {% set final_spam = email.user_override_spam_flag if email.user_override_spam_flag is not none else email.spam_flag %}
                        {% if final_spam %}<span class="badge bg-danger ms-2">üö´ SPAM</span>{% endif %}
                        {% elif email.optimization_status == 'done' and email.optimize_dringlichkeit is not none and email.optimization_completed_at and email.processed_at and email.optimization_completed_at > email.processed_at %}
                        Dringlichkeit: {{ email.optimize_dringlichkeit }} | Wichtigkeit: {{ email.optimize_wichtigkeit }} |
                        Aktion: {{ email.optimize_kategorie_aktion|replace('_',' ') if email.optimize_kategorie_aktion else email.kategorie_aktion|replace('_',' ') }}
                        {% set final_spam = email.optimize_spam_flag if email.optimize_spam_flag is not none else email.spam_flag %}
                        {% if final_spam %}<span class="badge bg-danger ms-2">üö´ SPAM</span>{% endif %}
                        {% if email.optimize_confidence and email.optimize_confidence < 0.7 %}
                        <span class="badge bg-warning text-dark ms-2" title="Niedrige Optimize-Confidence ({{ '%.0f'|format(email.optimize_confidence * 100) }}%) - Optimierung unsicher">‚ö†Ô∏è Opt. unsicher</span>
                        {% endif %}
                        {% else %}
                        Dringlichkeit: {{ email.dringlichkeit }} | Wichtigkeit: {{ email.wichtigkeit }} |
                        Aktion: {{ email.kategorie_aktion|replace('_',' ') }}
                        {% if email.spam_flag %}<span class="badge bg-danger ms-2">üö´ SPAM</span>{% endif %}
                        {% if email.ai_confidence and email.ai_confidence < 0.7 %}
                        <span class="badge bg-warning text-dark ms-2" title="Niedrige AI-Confidence ({{ '%.0f'|format(email.ai_confidence * 100) }}%) - bitte pr√ºfen">‚ö†Ô∏è Unsicher</span>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% if email.email_tags %}
                    <div class="mt-2">
                        {% for tag in email.email_tags %}
                        <span class="badge me-1" style="background-color: {{ tag.color }};">{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                    {% elif tag_list %}
                    <div class="mt-2">
                        <small class="text-muted">Legacy:</small>
                        {% for tag in tag_list if tag %}
                        <span class="badge bg-secondary">{{ tag.strip() }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-3 text-end">
                    {% if not email.done %}
                    <form method="post" action="/email/{{ email.raw_email_id }}/done" class="d-inline action-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="btn btn-sm btn-success action-btn" data-action="done">‚úì Erledigt</button>
                    </form>
                    {% else %}
                    <form method="post" action="/email/{{ email.raw_email_id }}/undo" class="d-inline action-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <button type="submit" class="btn btn-sm btn-outline-success action-btn" data-action="undo" title="Wieder als offen markieren">
                            ‚úì Erledigt
                        </button>
                    </form>
                    {% endif %}
                    <button type="button" class="btn btn-sm btn-outline-warning sync-action-btn" 
                            data-action="move-trash" data-email-id="{{ email.raw_email_id }}" 
                            title="In Papierkorb verschieben">üóëÔ∏è</button>
                    <button type="button" class="btn btn-sm btn-outline-danger sync-action-btn" 
                            data-action="delete" data-email-id="{{ email.raw_email_id }}" 
                            title="Permanent l√∂schen">üóëÔ∏è L√∂schen</button>
                    <a href="/email/{{ email.raw_email_id }}" class="btn btn-sm btn-outline-primary action-btn" data-action="details">Details</a>
                </div>
            </div>
        </li>

        {% else %}
        <li class="list-group-item text-center text-muted py-5">
            Keine E-Mails gefunden
        </li>
        {% endfor %}
    </ul>
</div>

<!-- P2-007: Pagination -->
{% if total_pages > 1 %}
<nav aria-label="Email pagination" class="mt-3">
    <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted small">
            Seite {{ page }} von {{ total_pages }} ({{ total_count }} E-Mails insgesamt)
        </div>
        <ul class="pagination pagination-sm mb-0">
            <!-- Previous -->
            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                <a class="page-link" href="?page={{ page - 1 }}{% if filter_account_id %}&mail_account={{ filter_account_id }}{% endif %}{% if filter_folder %}&folder={{ filter_folder }}{% endif %}{% if filter_seen %}&seen={{ filter_seen }}{% endif %}{% if filter_flagged %}&flagged={{ filter_flagged }}{% endif %}{% if filter_attachments %}&attach={{ filter_attachments }}{% endif %}{% if filter_tag_ids %}&tags={{ filter_tag_ids|join(',') }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if per_page != 50 %}&per_page={{ per_page }}{% endif %}" 
                   {% if page <= 1 %}tabindex="-1" aria-disabled="true"{% endif %}>
                    &laquo; Zur√ºck
                </a>
            </li>
            
            <!-- First Page -->
            {% if page > 3 %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if filter_account_id %}&mail_account={{ filter_account_id }}{% endif %}{% if filter_folder %}&folder={{ filter_folder }}{% endif %}{% if filter_seen %}&seen={{ filter_seen }}{% endif %}{% if filter_flagged %}&flagged={{ filter_flagged }}{% endif %}{% if filter_attachments %}&attach={{ filter_attachments }}{% endif %}{% if filter_tag_ids %}&tags={{ filter_tag_ids|join(',') }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if per_page != 50 %}&per_page={{ per_page }}{% endif %}">1</a>
            </li>
            {% if page > 4 %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            {% endif %}
            
            <!-- Pages around current -->
            {% for p in range([page - 2, 1]|max, [page + 2, total_pages]|min + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}{% if filter_account_id %}&mail_account={{ filter_account_id }}{% endif %}{% if filter_folder %}&folder={{ filter_folder }}{% endif %}{% if filter_seen %}&seen={{ filter_seen }}{% endif %}{% if filter_flagged %}&flagged={{ filter_flagged }}{% endif %}{% if filter_attachments %}&attach={{ filter_attachments }}{% endif %}{% if filter_tag_ids %}&tags={{ filter_tag_ids|join(',') }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if per_page != 50 %}&per_page={{ per_page }}{% endif %}">{{ p }}</a>
            </li>
            {% endfor %}
            
            <!-- Last Page -->
            {% if page < total_pages - 2 %}
            {% if page < total_pages - 3 %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            <li class="page-item">
                <a class="page-link" href="?page={{ total_pages }}{% if filter_account_id %}&mail_account={{ filter_account_id }}{% endif %}{% if filter_folder %}&folder={{ filter_folder }}{% endif %}{% if filter_seen %}&seen={{ filter_seen }}{% endif %}{% if filter_flagged %}&flagged={{ filter_flagged }}{% endif %}{% if filter_attachments %}&attach={{ filter_attachments }}{% endif %}{% if filter_tag_ids %}&tags={{ filter_tag_ids|join(',') }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if per_page != 50 %}&per_page={{ per_page }}{% endif %}">{{ total_pages }}</a>
            </li>
            {% endif %}
            
            <!-- Next -->
            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ page + 1 }}{% if filter_account_id %}&mail_account={{ filter_account_id }}{% endif %}{% if filter_folder %}&folder={{ filter_folder }}{% endif %}{% if filter_seen %}&seen={{ filter_seen }}{% endif %}{% if filter_flagged %}&flagged={{ filter_flagged }}{% endif %}{% if filter_attachments %}&attach={{ filter_attachments }}{% endif %}{% if filter_tag_ids %}&tags={{ filter_tag_ids|join(',') }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if sort_order %}&order={{ sort_order }}{% endif %}{% if per_page != 50 %}&per_page={{ per_page }}{% endif %}" 
                   {% if page >= total_pages %}tabindex="-1" aria-disabled="true"{% endif %}>
                    Weiter &raquo;
                </a>
            </li>
        </ul>
    </div>
</nav>
{% endif %}

</div><!-- end mb-5 pb-5 wrapper -->

<script nonce="{{ csp_nonce() }}">
document.addEventListener('DOMContentLoaded', function() {
    const filterSelects = document.querySelectorAll('.filter-select');
    const filterSearch = document.querySelector('.filter-search');
    const sortBySelect = document.getElementById('sortBy');
    const sortOrderBtn = document.getElementById('sortOrder');
    const accountSelect = document.getElementById('accountSelect');
    const folderSelect = document.getElementById('folderSelect');
    const perPageSelect = document.getElementById('perPageSelect');

    async function updateFolderDropdown(accountId) {
        if (!accountId || !folderSelect) {
            folderSelect.disabled = true;
            folderSelect.innerHTML = '<option value="">Erst Account w√§hlen</option>';
            return;
        }
        
        try {
            const response = await fetch(`/account/${accountId}/folders`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'include'
            });
            
            if (!response.ok) {
                console.error('Fehler beim Laden von Ordnern:', response.status);
                folderSelect.disabled = true;
                folderSelect.innerHTML = '<option value="">Fehler beim Laden</option>';
                return;
            }
            
            const data = await response.json();
            const folders = data.folders || [];
            const currentValue = folderSelect.value;
            
            folderSelect.disabled = false;
            folderSelect.innerHTML = '<option value="">Alle Ordner</option>';
            folders.forEach(folder => {
                const option = document.createElement('option');
                // API gibt {name: "INBOX"} zur\u00fcck, nicht nur String
                const folderName = typeof folder === 'string' ? folder : folder.name;
                option.value = folderName;
                option.textContent = folderName;
                if (folderName === currentValue) option.selected = true;
                folderSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Fehler beim Abrufen von Ordnern:', error);
            folderSelect.disabled = true;
            folderSelect.innerHTML = '<option value="">Fehler beim Laden</option>';
        }
    }

    // Phase F.1: Semantic Search Mode (global variable)
    window.searchMode = 'text'; // 'text' or 'semantic'
    
    function performSemanticSearch(query) {
        const emailListContainer = document.querySelector('.card:last-of-type .list-group');
        if (!emailListContainer) {
            console.error('[ERROR] Email list container not found!');
            return;
        }
        
        console.log('[DEBUG] performSemanticSearch starting for:', query);
        
        // Show loading state
        emailListContainer.innerHTML = '<li class="list-group-item"><div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Semantische Suche l√§uft...</p></div></li>';
        
        // Build API URL
        const params = new URLSearchParams({
            q: query,
            limit: 50,
            threshold: 0.25
        });
        
        // Account-Filter: Standardm√§√üig nur aktueller Account
        const accountSelect = document.getElementById('accountSelect');
        if (accountSelect && accountSelect.value) {
            params.append('account_id', accountSelect.value);
        }
        
        fetch(`/api/search/semantic?${params}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('[DEBUG] Semantic search results:', data);
                if (data.results && data.results.length > 0) {
                    renderSemanticResults(data.results);
                } else {
                    emailListContainer.innerHTML = '<li class="list-group-item"><div class="alert alert-info m-3">Keine semantischen Ergebnisse gefunden. Versuche Text-Suche oder andere Begriffe.</div></li>';
                }
            })
            .catch(error => {
                console.error('Semantic search error:', error);
                emailListContainer.innerHTML = `<li class="list-group-item"><div class="alert alert-danger m-3">Fehler bei semantischer Suche: ${error.message}</div></li>`;
            });
    }
    
    function renderSemanticResults(results) {
        const emailListContainer = document.querySelector('.card:last-of-type .list-group');
        if (!emailListContainer) {
            console.error('[ERROR] Email list container not found for rendering!');
            return;
        }
        
        console.log('[DEBUG] Rendering', results.length, 'semantic results');
        
        let html = '';
        
        results.forEach(result => {
            const date = result.date ? new Date(result.date).toLocaleDateString('de-DE') : 'N/A';
            const score = (result.similarity_score * 100).toFixed(0);
            
            html += `
                <li class="list-group-item">
                    <a href="/email/${result.email_id}" class="text-decoration-none">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${escapeHtml(result.subject || '(Kein Betreff)')}</h6>
                                <p class="mb-1 text-muted small">
                                    <strong>Von:</strong> ${escapeHtml(result.from)} | ${date}
                                </p>
                                <p class="mb-2 small">${escapeHtml(result.snippet)}</p>
                            </div>
                            <span class="badge bg-primary ms-3" title="Semantic Similarity Score">
                                üß† ${score}%
                            </span>
                        </div>
                    </a>
                </li>
            `;
        });
        
        emailListContainer.innerHTML = html;
        
        // Update count
        const emailListCount = document.getElementById('emailListCount');
        if (emailListCount) {
            emailListCount.textContent = results.length;
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function updateFilters() {
        // Phase F.1: Check if semantic search mode is active
        const searchInput = document.getElementById('searchInput');
        console.log('[DEBUG] updateFilters called, searchMode:', window.searchMode, 'value:', searchInput?.value);
        
        if (window.searchMode === 'semantic' && searchInput && searchInput.value.trim()) {
            console.log('[DEBUG] Triggering semantic search for:', searchInput.value.trim());
            performSemanticSearch(searchInput.value.trim());
            return;
        }
        
        console.log('[DEBUG] Using normal text-based filtering');
        // Normal text-based filtering
        const params = new URLSearchParams();

        filterSelects.forEach(select => {
            const value = select.value.trim();
            if (value) {
                const filterName = select.dataset.filter;
                params.set(filterName, value);
            }
        });

        if (filterSearch && filterSearch.value.trim()) {
            params.set('search', filterSearch.value.trim());
        }

        if (sortBySelect && sortBySelect.value) {
            params.set('sort', sortBySelect.value);
        }

        const currentOrder = sortOrderBtn?.dataset.order || 'desc';
        params.set('order', currentOrder);

        // Per-page selection
        if (perPageSelect && perPageSelect.value && perPageSelect.value !== '50') {
            params.set('per_page', perPageSelect.value);
        }

        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        
        // Full page reload for reliable filter application
        window.location.href = newUrl;
    }

    function applyFiltersViaAjax(params) {
        const url = '/list?' + params.toString();
        
        const resultCount = document.getElementById('resultCount');
        if (resultCount) resultCount.textContent = '‚è≥...';

        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Update email list card
            const newListHtml = doc.querySelector('#emailListCard');
            const oldListHtml = document.querySelector('#emailListCard');
            
            if (newListHtml && oldListHtml) {
                oldListHtml.replaceWith(newListHtml);
                attachActionFormListeners();
            }

            // Update TOP pagination info
            const newTopPagination = doc.querySelector('#topPaginationBar');
            const oldTopPagination = document.querySelector('#topPaginationBar');
            if (newTopPagination && oldTopPagination) {
                oldTopPagination.replaceWith(newTopPagination);
                // Re-attach perPageSelect listener
                const newPerPageSelect = document.getElementById('perPageSelect');
                if (newPerPageSelect) {
                    newPerPageSelect.addEventListener('change', function() {
                        const params = new URLSearchParams(window.location.search);
                        const newPerPage = this.value;
                        if (newPerPage === '50') {
                            params.delete('per_page');
                        } else {
                            params.set('per_page', newPerPage);
                        }
                        params.delete('page');
                        window.location.href = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
                    });
                }
            }

            // Update bottom pagination
            const newBottomPagination = doc.querySelector('nav[aria-label="Email pagination"]');
            const oldBottomPagination = document.querySelector('nav[aria-label="Email pagination"]');
            if (newBottomPagination) {
                if (oldBottomPagination) {
                    oldBottomPagination.replaceWith(newBottomPagination);
                } else {
                    // Insert after email list if pagination didn't exist before
                    const listCard = document.querySelector('#emailListCard');
                    if (listCard) {
                        listCard.after(newBottomPagination);
                    }
                }
            } else if (oldBottomPagination) {
                // Remove pagination if no longer needed
                oldBottomPagination.remove();
            }

            // Update total count in top bar
            const newTotalCount = doc.querySelector('#topPaginationBar strong');
            const oldTotalCount = document.querySelector('#topPaginationBar strong');
            if (newTotalCount && oldTotalCount) {
                oldTotalCount.textContent = newTotalCount.textContent;
            }

            const emailCount = doc.querySelector('.card-header');
            if (emailCount && resultCount) {
                const countMatch = emailCount.textContent.match(/(\d+)\s+Mails/);
                if (countMatch) {
                    resultCount.textContent = countMatch[1];
                    const newListCount = document.querySelector('#emailListCount');
                    if (newListCount) {
                        newListCount.textContent = countMatch[1];
                    }
                }
            }

            updateActiveFilterBadge(params);
        })
        .catch(error => {
            console.error('Filter-Fehler:', error);
            if (resultCount) resultCount.textContent = 'Fehler';
        });
    }

    function updateActiveFilterBadge(params) {
        const activeCount = params.toString().split('&').filter(p => p).length;
        const badge = document.getElementById('activeFilters');
        if (badge) {
            if (activeCount > 0) {
                badge.textContent = activeCount + ' aktiv';
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    function attachActionFormListeners() {
        let isProcessing = false;

        document.querySelectorAll('.action-form').forEach(form => {
            form.removeEventListener('submit', handleFormSubmit);
            form.addEventListener('submit', handleFormSubmit);
        });

        function handleFormSubmit(e) {
            if (isProcessing) {
                e.preventDefault();
                return false;
            }
            const btn = this.querySelector('.action-btn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥...';
            isProcessing = true;
        }

        document.querySelectorAll('.action-btn[data-action="details"]').forEach(btn => {
            btn.removeEventListener('click', handleDetailsClick);
            btn.addEventListener('click', handleDetailsClick);
        });

        function handleDetailsClick(e) {
            if (isProcessing) {
                e.preventDefault();
                return false;
            }
        }
    }

    filterSelects.forEach(select => {
        select.addEventListener('change', async function() {
            if (this === accountSelect) {
                const accountId = this.value;
                if (accountId) {
                    // Warten bis Folder-Dropdown aktualisiert ist, bevor Seite neu l√§dt
                    await updateFolderDropdown(accountId);
                }
            }
            updateFilters();
        });
    });

    if (filterSearch) {
        let searchTimeout;
        filterSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(updateFilters, 500);
        });
    }

    if (sortBySelect) {
        sortBySelect.addEventListener('change', updateFilters);
    }

    // Per-page selection - triggers full page reload to recalculate pagination
    if (perPageSelect) {
        perPageSelect.addEventListener('change', function() {
            const params = new URLSearchParams(window.location.search);
            const newPerPage = this.value;
            if (newPerPage === '50') {
                params.delete('per_page');
            } else {
                params.set('per_page', newPerPage);
            }
            // Reset to page 1 when changing per_page
            params.delete('page');
            window.location.href = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        });
    }

    if (sortOrderBtn) {
        sortOrderBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const currentOrder = this.dataset.order || 'desc';
            const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            this.dataset.order = newOrder;
            this.textContent = newOrder === 'asc' ? '‚Üë' : '‚Üì';
            updateFilters();
        });
    }

    // ===== Phase F.1: Semantic Search Toggle =====
    const searchModeOptions = document.querySelectorAll('.search-mode-option');
    const searchModeLabel = document.getElementById('searchModeLabel');
    const searchModeHint = document.getElementById('searchModeHint');
    
    searchModeOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            window.searchMode = this.dataset.mode;
            console.log('[DEBUG] Search mode changed to:', window.searchMode);
            
            if (window.searchMode === 'semantic') {
                searchModeLabel.textContent = 'Semantisch';
                searchModeHint.style.display = 'block';
            } else {
                searchModeLabel.textContent = 'Text';
                searchModeHint.style.display = 'none';
            }
            
            // Re-trigger search if there's a query
            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchInput.value.trim()) {
                console.log('[DEBUG] Re-triggering search with existing query');
                updateFilters();
            }
        });
    });
    // ===== End Phase F.1 =====

    // ===== Sync Action Buttons (Papierkorb & Permanent L√∂schen) =====
    document.querySelectorAll('.sync-action-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const action = this.dataset.action;
            const emailId = this.dataset.emailId;
            
            let confirmMsg = '';
            if (action === 'delete') {
                confirmMsg = 'üóëÔ∏è Email wirklich PERMANENT L√ñSCHEN? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.';
            } else if (action === 'move-trash') {
                confirmMsg = 'üóëÔ∏è Email in Papierkorb verschieben?';
            }
            
            if (!confirm(confirmMsg)) return;
            
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥';
            
            try {
                const response = await fetch(`/email/${emailId}/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // DELETE: Email komplett entfernen
                    // MOVE-TRASH: Page reload damit Filter korrekt zeigt
                    if (action === 'delete') {
                        // Permanent gel√∂scht ‚Üí aus Liste entfernen
                        const listItem = btn.closest('li');
                        listItem.style.transition = 'opacity 0.3s';
                        listItem.style.opacity = '0';
                        setTimeout(() => {
                            listItem.remove();
                            // Check if list is empty
                            const emailList = document.getElementById('emailList');
                            if (emailList && emailList.querySelectorAll('li').length === 0) {
                                emailList.innerHTML = '<li class="list-group-item text-center text-muted py-5">Keine E-Mails gefunden</li>';
                            }
                        }, 300);
                    } else if (action === 'move-trash') {
                        // In Papierkorb ‚Üí Seite neu laden (zeigt dann in "Gel√∂scht" Filter)
                        window.location.reload();
                    }
                } else {
                    alert('‚ùå ' + (data.error || 'Fehler bei der Aktion'));
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Sync action error:', error);
                alert('‚ùå Netzwerk-Fehler: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    });
    // ===== End Sync Action Buttons =====

    attachActionFormListeners();

    const params = new URLSearchParams(window.location.search);
    updateActiveFilterBadge(params);

    if (accountSelect && accountSelect.value) {
        updateFolderDropdown(accountSelect.value);
    }
});
</script>
{% endblock %}
