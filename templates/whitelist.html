{% extends "base.html" %}

{% block title %}Trusted Senders - Mail Helper{% endblock %}

{% block content %}
<div class="container-xxl mt-4 pb-5 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">📬 Trusted Senders</h2>
            <p class="text-muted mb-0">Verwalte vertrauenswürdige Absender für automatische VIP-Behandlung</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('mail_fetch_config') }}" class="btn btn-outline-primary">
                🤖 AI-Einstellungen
            </a>
            <a href="{{ url_for('settings') }}" class="btn btn-outline-secondary">
                ⚙️ Zurück zu Einstellungen
            </a>
        </div>
    </div>

    <!-- Main 2-Column Layout -->
    <div class="row g-4">
        <!-- LEFT COLUMN: List & Management -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm bg-dark text-light" style="min-height: 600px;">
                <div class="card-header" style="background: linear-gradient(135deg, #1e293b, #0f172a);">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h6 class="mb-0 text-light">📋 Bestehende Einträge</h6>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-primary" id="refreshListBtn" title="Liste aktualisieren">
                                🔄 Aktualisieren
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter & Account Selector -->
                    <div class="row g-2 mt-3">
                        <div class="col-md-6">
                            <select class="form-select form-select-sm bg-dark text-light border-secondary" id="whitelistAccountSelectorV2">
                                <option value="">🌍 Alle anzeigen</option>
                                <option value="global">🌐 Nur Global</option>
                                {% for account in mail_accounts %}
                                <option value="{{ account.id }}">📧 {{ account.decrypted_imap_username or account.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary" 
                                   id="filterPatternInput" placeholder="🔍 Pattern suchen...">
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div id="trustedSendersListV2" style="max-height: 600px; overflow-y: auto;">
                        <div class="text-center text-muted py-5">
                            <div class="spinner-border spinner-border-sm mb-2" role="status">
                                <span class="visually-hidden">Laden...</span>
                            </div>
                            <div>Lade Einträge...</div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-dark border-secondary">
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <small class="text-light opacity-75">Limit: 500 pro Account</small>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-danger btn-sm" id="deleteSelectedBtn" disabled>
                                🗑️ Ausgewählte löschen
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm" id="selectAllBtn">
                                ☑️ Alle auswählen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Add Form -->
        <div class="col-lg-4">
            <!-- Add New Form -->
            <div class="card border-0 shadow-sm mb-4 bg-dark text-light" style="min-height: 600px;">
                <div class="card-header" style="background: linear-gradient(135deg, #064e3b, #022c22);">
                    <h6 class="mb-0 text-light">➕ Neuer Eintrag</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="trustedSenderPatternV2" class="form-label small text-light">Absender-Muster</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" 
                               id="trustedSenderPatternV2" 
                               placeholder="z.B. boss@company.de">
                    </div>
                    <div class="mb-3">
                        <label for="trustedSenderTypeV2" class="form-label small text-light">Typ</label>
                        <select class="form-select bg-dark text-light border-secondary" id="trustedSenderTypeV2">
                            <option value="exact">🔒 Exakt - nur boss@company.de</option>
                            <option value="email_domain">👥 Wildcard - alle @company.de</option>
                            <option value="domain">🏢 Domain + Subdomains (z.B. mail.company.de)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="trustedSenderAccountIdV2" class="form-label small text-light">Account</label>
                        <select class="form-select bg-dark text-light border-secondary" id="trustedSenderAccountIdV2">
                            <option value="">🌍 Global (alle Accounts)</option>
                            {% for account in mail_accounts %}
                            <option value="{{ account.id }}">📧 {{ account.decrypted_imap_username or account.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="trustedSenderLabelV2" class="form-label small text-light">Label (optional)</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" 
                               id="trustedSenderLabelV2" 
                               placeholder="z.B. CEO, HR">
                    </div>
                    <button type="button" class="btn btn-success w-100" id="addTrustedSenderBtnV2">
                        ➕ Hinzufügen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Suggestions - Full Width -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-dark text-light">
                <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #0c4a6e, #082f49);">
                    <h6 class="mb-0 text-light">💡 Schnell-Vorschläge</h6>
                    <button type="button" class="btn btn-info btn-sm" id="loadSuggestionsBtnV2">
                        🔍 Vorschläge laden
                    </button>
                </div>
                <div class="card-body">
                    <p class="small text-light opacity-75 mb-3">Basierend auf deinem Email-Verlauf – klicke auf ➕ um einen Vorschlag zur Whitelist hinzuzufügen</p>
                    <div class="mb-3">
                        <label class="form-label small text-light mb-2">📧 Account für Vorschläge:</label>
                        <select class="form-select form-select-sm bg-dark text-light border-secondary" id="suggestionsAccountSelectorV2">
                            <option value="">🌍 Alle anzeigen</option>
                            <option value="global">🌐 Nur Global</option>
                            {% for account in mail_accounts %}
                            <option value="{{ account.id }}">📧 {{ account.decrypted_imap_username or account.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="suggestionsListV2" style="display: none;">
                        <div class="row g-2" id="suggestionsGrid">
                            <!-- Suggestions loaded here as cards in a grid -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce() }}">
// ========================================
// WHITELIST PAGE JavaScript
// ========================================

// Selected items tracking
let selectedSenders = new Set();
let filterTimeout = null;

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCsrfToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}

async function safeFetch(url, options = {}) {
    const csrfToken = getCsrfToken();
    if (csrfToken && !options.headers) {
        options.headers = {};
    }
    if (csrfToken && options.headers) {
        options.headers['X-CSRFToken'] = csrfToken;
    }
    
    try {
        const response = await fetch(url, options);
        if (!response.ok) {
            let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
            try {
                const errorData = await response.json();
                errorMsg = errorData.error || errorMsg;
            } catch {}
            throw new Error(errorMsg);
        }
        try {
            return await response.json();
        } catch (e) {
            throw new Error('Invalid JSON response from server');
        }
    } catch (error) {
        if (error instanceof TypeError && error.message.includes('fetch')) {
            throw new Error('Netzwerkfehler: Server nicht erreichbar');
        }
        throw error;
    }
}


// Load trusted senders list V2 with filters
async function loadTrustedSendersListV2() {
    try {
        const accountSelector = document.getElementById('whitelistAccountSelectorV2');
        const filterInput = document.getElementById('filterPatternInput');
        const selectedAccountId = accountSelector ? accountSelector.value : '';
        const filterText = filterInput ? filterInput.value.toLowerCase() : '';
        
        // Build URL with account_id if selected
        let url = '/api/trusted-senders';
        if (selectedAccountId && selectedAccountId !== 'global') {
            url += `?account_id=${selectedAccountId}`;
        }
        
        const data = await safeFetch(url, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        if (!data.success) {
            console.error('Failed to load trusted senders:', data.error);
            return;
        }
        
        let senders = data.senders;
        
        // Filter by account type
        if (selectedAccountId === 'global') {
            senders = senders.filter(s => !s.account_id);
        }
        
        // Filter by pattern text
        if (filterText) {
            senders = senders.filter(s => 
                s.sender_pattern.toLowerCase().includes(filterText) ||
                (s.label && s.label.toLowerCase().includes(filterText))
            );
        }
        
        const list = document.getElementById('trustedSendersListV2');
        const countBadge = document.getElementById('trustedSendersCount');
        
        if (countBadge) {
            countBadge.textContent = senders.length;
        }
        
        if (senders.length === 0) {
            list.innerHTML = `
                <div class="text-center text-light py-5">
                    <div class="mb-2">📭</div>
                    <div>Keine Einträge gefunden</div>
                    ${filterText ? '<small class="text-light opacity-75">Versuche einen anderen Filter</small>' : ''}
                </div>
            `;
            return;
        }
        
        list.innerHTML = senders.map(sender => `
            <div class="border-bottom border-secondary p-3 hover-bg-light" style="transition: background 0.2s;" 
                 data-sender-id="${sender.id}">
                <div class="d-flex align-items-start gap-3">
                    <input type="checkbox" class="form-check-input mt-1 sender-checkbox" 
                           data-sender-id="${sender.id}" 
                           ${selectedSenders.has(sender.id) ? 'checked' : ''}>
                    
                    <div style="flex-grow: 1;">
                        <div class="d-flex gap-2 align-items-center mb-2 flex-wrap">
                            <select class="form-select form-select-sm sender-type-select" style="width: auto;" 
                                    data-sender-id="${sender.id}">
                                <option value="exact" ${sender.pattern_type === 'exact' ? 'selected' : ''}>🔒 Exakt</option>
                                <option value="email_domain" ${sender.pattern_type === 'email_domain' ? 'selected' : ''}>👥 Wildcard</option>
                                <option value="domain" ${sender.pattern_type === 'domain' ? 'selected' : ''}>🏢 Domain + Subdomains</option>
                            </select>
                            
                            ${sender.account_id ? 
                                `<span class="badge bg-warning text-dark">📧 Account ${sender.account_id}</span>` : 
                                `<span class="badge bg-secondary">🌍 Global</span>`
                            }
                            
                            ${sender.use_urgency_booster ? 
                                `<span class="badge bg-success">⚡ Booster</span>` : 
                                `<span class="badge bg-secondary">⭕ Kein Booster</span>`
                            }
                        </div>
                        
                        <div class="font-monospace small mb-1">${escapeHtml(sender.sender_pattern)}</div>
                        
                        ${sender.label ? 
                            `<div class="small text-light opacity-75">📝 ${sender.label}</div>` : 
                            ''
                        }
                        
                        <div class="small text-light opacity-75 mt-1">
                            📧 ${sender.email_count} Emails
                            ${sender.last_seen_at ? 
                                ` • Zuletzt: ${new Date(sender.last_seen_at).toLocaleDateString('de-DE')}` : 
                                ''
                            }
                        </div>
                    </div>
                    
                    <div class="d-flex flex-column gap-1">
                        <button type="button" class="btn btn-sm btn-outline-warning edit-sender-btn" 
                                data-sender-id="${sender.id}"
                                data-sender-label="${(sender.label || '').replace(/'/g, "\\'")}" 
                                title="Label bearbeiten">
                            ✏️
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-sender-btn" 
                                data-sender-id="${sender.id}"
                                title="Löschen">
                            🗑️
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Bind checkbox events
        document.querySelectorAll('.sender-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                const senderId = parseInt(this.getAttribute('data-sender-id'));
                if (this.checked) {
                    selectedSenders.add(senderId);
                } else {
                    selectedSenders.delete(senderId);
                }
                updateBatchButtons();
            });
        });
        
    } catch (error) {
        console.error('Error loading trusted senders V2:', error);
        showToast(`Fehler: ${error.message}`, 'danger');
        document.getElementById('trustedSendersListV2').innerHTML = 
            `<div class="alert alert-danger m-3"><strong>Fehler beim Laden:</strong> ${escapeHtml(error.message)}</div>`;
    }
}

// Update sender type
async function updateSenderTypeV2(senderId, newType) {
    try {
        const response = await safeFetch(`/api/trusted-senders/${senderId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({pattern_type: newType})
        });
        
        
        if (data.success) {
            console.log('✅ Type updated');
        } else {
            alert('Fehler: ' + data.error);
            loadTrustedSendersListV2();
        }
    } catch (error) {
        console.error('Error updating type:', error);
        alert('Fehler beim Aktualisieren');
        loadTrustedSendersListV2();
    }
}

// Toggle urgency booster
// Edit sender label
async function editSenderLabelV2(senderId, currentLabel) {
    const newLabel = prompt('Neues Label eingeben:', currentLabel);
    if (newLabel === null) return; // Cancelled
    
    try {
        const data = await safeFetch(`/api/trusted-senders/${senderId}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({label: newLabel.trim() || null})
        });
        
        if (data.success) {
            loadTrustedSendersListV2();
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (error) {
        console.error('Error updating label:', error);
        alert('Fehler beim Aktualisieren');
    }
}

// Delete single sender
async function deleteSenderV2(senderId) {
    if (!confirm('Diesen Eintrag wirklich löschen?')) return;
    
    try {
        const data = await safeFetch(`/api/trusted-senders/${senderId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        
        if (data.success) {
            selectedSenders.delete(senderId);
            loadTrustedSendersListV2();
        } else {
            alert('Fehler: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting sender:', error);
        alert('Fehler beim Löschen');
    }
}

// Validation helper for trusted sender input
function validateTrustedSenderInput(pattern, type, label) {
    const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
    const domainRegex = /^[a-z0-9]([a-z0-9-]*[a-z0-9])?(\.[a-z0-9]([a-z0-9-]*[a-z0-9])?)*\.[a-z]{2,}$/i;
    
    if (!pattern) {
        return { valid: false, error: 'Bitte Absender-Muster eingeben' };
    }
    
    if (pattern.length > 255) {
        return { valid: false, error: 'Pattern zu lang (max 255 Zeichen)' };
    }
    
    if (type === 'exact') {
        if (!emailRegex.test(pattern)) {
            return { valid: false, error: 'Ungültiges Email-Format (z.B. boss@company.de)' };
        }
    } else if (type === 'email_domain') {
        if (!pattern.startsWith('@')) {
            return { valid: false, error: 'Domain-Pattern muss mit @ beginnen (z.B. @company.de)' };
        }
        const domainPart = pattern.substring(1);
        if (!domainRegex.test(domainPart)) {
            return { valid: false, error: 'Ungültiges Domain-Format nach @ (z.B. @company.de)' };
        }
    } else if (type === 'domain') {
        if (!domainRegex.test(pattern)) {
            return { valid: false, error: 'Ungültiges Domain-Format (z.B. company.de)' };
        }
    }
    
    if (label && label.length > 100) {
        return { valid: false, error: 'Label zu lang (max 100 Zeichen)' };
    }
    
    return { valid: true };
}

// Add new trusted sender V2
async function addTrustedSenderV2() {
    const pattern = document.getElementById('trustedSenderPatternV2').value.trim();
    const type = document.getElementById('trustedSenderTypeV2').value;
    const label = document.getElementById('trustedSenderLabelV2').value.trim() || null;
    const accountId = document.getElementById('trustedSenderAccountIdV2').value || null;
    
    const validation = validateTrustedSenderInput(pattern, type, label);
    if (!validation.valid) {
        showToast(`⚠️ ${validation.error}`, 'danger');
        document.getElementById('trustedSenderPatternV2').focus();
        return;
    }
    
    try {
        const btn = document.getElementById('addTrustedSenderBtnV2');
        btn.disabled = true;
        btn.textContent = '⏳ Füge hinzu...';
        
        const data = await safeFetch('/api/trusted-senders', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                sender_pattern: pattern,
                pattern_type: type,
                label: label,
                use_urgency_booster: true,
                account_id: accountId ? parseInt(accountId) : null
            })
        });
        
        console.log('Add trusted sender response:', data); // Debug log
        
        if (!data.success) {
            alert(`❌ Fehler: ${data.error}`);
            return;
        }
        
        // Reset form
        document.getElementById('trustedSenderPatternV2').value = '';
        document.getElementById('trustedSenderLabelV2').value = '';
        document.getElementById('trustedSenderTypeV2').value = 'exact';
        document.getElementById('trustedSenderAccountIdV2').value = '';
        
        // Reload list
        loadTrustedSendersListV2();
        
        // Show appropriate message
        if (data.already_exists) {
            showToast(`ℹ️ ${data.message}`, 'info');
        } else {
            showToast('✅ Absender hinzugefügt!', 'success');
        }
        
    } catch (error) {
        console.error('Error adding sender:', error);
        alert(`❌ Fehler: ${error.message}`);
    } finally {
        const btn = document.getElementById('addTrustedSenderBtnV2');
        btn.disabled = false;
        btn.textContent = '➕ Hinzufügen';
    }
}

// Load suggestions V2
async function loadSuggestionsV2() {
    const btn = document.getElementById('loadSuggestionsBtnV2');
    const list = document.getElementById('suggestionsListV2');
    const accountSelector = document.getElementById('suggestionsAccountSelectorV2');
    
    btn.disabled = true;
    btn.textContent = '⏳ Laden...';
    
    try {
        const selectedAccountId = accountSelector ? accountSelector.value : '';
        let url = '/api/trusted-senders/suggestions';
        if (selectedAccountId && selectedAccountId !== 'global') {
            url += `?account_id=${selectedAccountId}`;
        }
        
        const data = await safeFetch(url, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        
        if (!data.success || data.suggestions.length === 0) {
            list.innerHTML = '<div class="text-muted small">Keine Vorschläge verfügbar</div>';
            list.style.display = 'block';
            return;
        }
        
        // Render as horizontal grid
        const grid = document.getElementById('suggestionsGrid') || list;
        grid.innerHTML = data.suggestions.slice(0, 10).map(suggestion => {
            const rawSender = suggestion.sender || '';
            const safeSender = rawSender.replace(/[&<>"']/g, c => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[c]));
            const encodedSender = btoa(unescape(encodeURIComponent(rawSender)));
            const type = suggestion.suggested_pattern_type || 'exact';
            
            return `
                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="border border-info rounded p-2 h-100 d-flex justify-content-between align-items-center" style="background: rgba(6, 182, 212, 0.1);">
                        <div style="flex-grow: 1; min-width: 0;">
                            <div class="small font-monospace text-info text-truncate fw-bold" title="${safeSender}">${safeSender}</div>
                            <div class="small text-info opacity-75">📧 ${suggestion.email_count} Mails</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-success ms-2 suggestion-add-btn-v2"
                                data-sender-raw="${encodedSender}"
                                data-type="${type}">
                            ➕
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        // Bind events
        grid.querySelectorAll('.suggestion-add-btn-v2').forEach(btn => {
            btn.addEventListener('click', function() {
                const encodedSender = this.getAttribute('data-sender-raw') || '';
                let sender = '';
                try {
                    sender = decodeURIComponent(escape(atob(encodedSender)));
                } catch (e) {
                    console.error('Decode failed:', e);
                }
                const type = this.getAttribute('data-type');
                const selectedAccount = document.getElementById('suggestionsAccountSelectorV2').value;
                
                document.getElementById('trustedSenderPatternV2').value = sender;
                document.getElementById('trustedSenderTypeV2').value = type;
                document.getElementById('trustedSenderAccountIdV2').value = selectedAccount === 'global' ? '' : selectedAccount;
                document.getElementById('trustedSenderPatternV2').focus();
            });
        });
        
        list.style.display = 'block';
    } catch (error) {
        list.innerHTML = `<div class="alert alert-danger small">Fehler: ${error.message}</div>`;
        list.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = '🔍 Vorschläge laden';
    }
}

// Select/deselect all
function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.sender-checkbox');
    const allSelected = selectedSenders.size === checkboxes.length && checkboxes.length > 0;
    
    checkboxes.forEach(cb => {
        const senderId = parseInt(cb.getAttribute('data-sender-id'));
        if (allSelected) {
            cb.checked = false;
            selectedSenders.delete(senderId);
        } else {
            cb.checked = true;
            selectedSenders.add(senderId);
        }
    });
    
    updateBatchButtons();
}

// Delete selected
async function deleteSelected() {
    if (selectedSenders.size === 0) return;
    
    const count = selectedSenders.size;
    if (!confirm(`Wirklich ${count} Einträge löschen?`)) return;
    
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const origText = deleteBtn.textContent;
    deleteBtn.disabled = true;
    deleteBtn.textContent = '🔄 Lösche...';
    
    try {
        const deletePromises = Array.from(selectedSenders).map(id => 
            safeFetch(`/api/trusted-senders/${id}`, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'}
            })
        );
        
        const results = await Promise.allSettled(deletePromises);
        const succeeded = results.filter(r => r.status === 'fulfilled' && r.value && r.value.success).length;
        const failed = results.filter(r => r.status === 'rejected' || !r.value || !r.value.success).length;
        
        selectedSenders.clear();
        updateBatchButtons();
        
        if (failed > 0) {
            showToast(`${succeeded} gelöscht, ${failed} Fehler`, 'warning');
        } else {
            showToast(`${succeeded} Einträge erfolgreich gelöscht`, 'success');
        }
        
        await loadTrustedSendersListV2();
    } catch (error) {
        console.error('Batch delete error:', error);
        showToast('Fehler beim Löschen', 'danger');
    } finally {
        deleteBtn.disabled = false;
        deleteBtn.textContent = origText;
    }
}

// 

// Update batch button states
function updateBatchButtons() {
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const selectBtn = document.getElementById('selectAllBtn');
    
    if (deleteBtn) {
        deleteBtn.disabled = selectedSenders.size === 0;
        deleteBtn.innerHTML = `🗑️ Ausgewählte löschen${selectedSenders.size > 0 ? ` (${selectedSenders.size})` : ''}`;
    }
    
    if (selectBtn) {
        const checkboxes = document.querySelectorAll('.sender-checkbox');
        const allSelected = selectedSenders.size === checkboxes.length && checkboxes.length > 0;
        selectBtn.textContent = allSelected ? '☐ Alle abwählen' : '☑️ Alle auswählen';
    }
}

// Toast notification helper
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    console.log(`[Toast] ${type}: ${message}`);
    setTimeout(() => toast.remove(), 5000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadTrustedSendersListV2();
    
    // Bind event listeners
    const addBtn = document.getElementById('addTrustedSenderBtnV2');
    if (addBtn) {
        addBtn.addEventListener('click', addTrustedSenderV2);
    }
    
    const refreshBtn = document.getElementById('refreshListBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadTrustedSendersListV2);
    }
    
    const suggestionsBtn = document.getElementById('loadSuggestionsBtnV2');
    if (suggestionsBtn) {
        suggestionsBtn.addEventListener('click', loadSuggestionsV2);
    }
    
    const accountSelector = document.getElementById('whitelistAccountSelectorV2');
    if (accountSelector) {
        accountSelector.addEventListener('change', loadTrustedSendersListV2);
    }
    
    const filterInput = document.getElementById('filterPatternInput');
    if (filterInput) {
        window.addEventListener('beforeunload', () => {
            if (filterTimeout) clearTimeout(filterTimeout);
        });
        
        filterInput.addEventListener('input', () => {
            if (filterTimeout) clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                loadTrustedSendersListV2();
                filterTimeout = null;
            }, 300);
        });
    }
    
    const selectAllBtn = document.getElementById('selectAllBtn');
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', toggleSelectAll);
    }
    
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', deleteSelected);
    }
    
    const patternInput = document.getElementById('trustedSenderPatternV2');
    if (patternInput) {
        patternInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTrustedSenderV2();
            }
        });
    }
    
    // Event delegation for dynamically created buttons
    document.addEventListener('click', function(e) {
        // Edit sender label
        if (e.target.classList.contains('edit-sender-btn')) {
            const senderId = e.target.dataset.senderId;
            const currentLabel = e.target.dataset.senderLabel;
            editSenderLabelV2(parseInt(senderId), currentLabel);
        }
        
        // Delete sender
        if (e.target.classList.contains('delete-sender-btn')) {
            const senderId = e.target.dataset.senderId;
            deleteSenderV2(parseInt(senderId));
        }
    });
    
    // Event delegation for sender type select changes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('sender-type-select')) {
            const senderId = e.target.dataset.senderId;
            updateSenderTypeV2(parseInt(senderId), e.target.value);
        }
    });
});
</script>
{% endblock %}
