{% extends "base.html" %}

{% block title %}Auto-Rules Management{% endblock %}

{% block head %}
<style>
/* Farbige Tag-Indikatoren wie in email_detail.html */
.tag-color-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
    border: 1px solid rgba(0,0,0,0.1);
}

/* Tag-Select Styling */
select#rule-apply-tag option,
select#rule-tag-value option,
select#rule-ai-tag-value option {
    padding: 4px 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-xxl mt-4">
    <h2 class="mb-4">
        <i class="bi bi-lightning-charge"></i> Auto-Action Rules
    </h2>

    <p class="lead">
        Automatisiere E-Mail-Aktionen mit benutzerdefinierten Regeln.
    </p>

    <!-- Action Buttons -->
    <div class="d-flex gap-2 mb-4">
        <button class="btn btn-primary" id="btn-create-rule">
            <i class="bi bi-plus-circle"></i> Neue Regel erstellen
        </button>
        <button class="btn btn-outline-primary" id="btn-create-from-template">
            <i class="bi bi-file-earmark-check"></i> Aus Template erstellen
        </button>
        <button class="btn btn-success" id="btn-apply-rules">
            <i class="bi bi-play-fill"></i> Regeln jetzt anwenden
        </button>
    </div>

    <!-- Rules List -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Meine Regeln ({{ rules|length }})</h5>
        </div>
        <div class="card-body">
            {% if rules %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="30">Status</th>
                                <th>Name</th>
                                <th>Priorität</th>
                                <th>Bedingungen</th>
                                <th>Aktionen</th>
                                <th>Ausgelöst</th>
                                <th width="150">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rule in rules %}
                            <tr data-rule-id="{{ rule.id }}">
                                <td>
                                    {% if rule.is_active %}
                                        <span class="badge bg-success" title="Aktiv">✓</span>
                                    {% else %}
                                        <span class="badge bg-secondary" title="Inaktiv">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ rule.name }}</strong>
                                    {% if rule.description %}
                                        <br><small class="text-muted">{{ rule.description }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ rule.priority }}</span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ rule.conditions|length }} Bedingung(en)
                                    </small>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ rule.actions|length }} Aktion(en)
                                    </small>
                                </td>
                                <td>
                                    <small>
                                        {{ rule.times_triggered }}x
                                        {% if rule.last_triggered_at %}
                                            <br><span class="text-muted">{{ rule.last_triggered_at.strftime('%d.%m.%Y %H:%M') }}</span>
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary btn-test-rule" 
                                                data-rule-id="{{ rule.id }}"
                                                title="Testen">
                                            <i class="bi bi-play"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary btn-edit-rule" 
                                                data-rule-id="{{ rule.id }}"
                                                title="Bearbeiten">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-delete-rule" 
                                                data-rule-id="{{ rule.id }}"
                                                title="Löschen">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Keine Regeln vorhanden. 
                    <button class="btn btn-sm btn-primary" id="btn-create-first-rule">
                        Erste Regel erstellen
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Templates Section -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Regel-Templates</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Schnellstart mit vordefinierten Regeln:</p>
            <div id="templates-list" class="row"></div>
        </div>
    </div>
</div>

<!-- Modal: Create/Edit Rule -->
<div class="modal fade" id="modal-rule-editor" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Regel erstellen/bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-rule-editor">
                    <input type="hidden" id="rule-id" value="">
                    
                    <!-- Name -->
                    <div class="mb-3">
                        <label for="rule-name" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="rule-name" required>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-3">
                        <label for="rule-description" class="form-label">Beschreibung</label>
                        <textarea class="form-control" id="rule-description" rows="2"></textarea>
                    </div>
                    
                    <!-- Priority & Active -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="rule-priority" class="form-label">Priorität</label>
                            <input type="number" class="form-control" id="rule-priority" value="100" min="1">
                            <small class="text-muted">Niedrigere Zahl = höhere Priorität</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="rule-is-active" checked>
                                <label class="form-check-label" for="rule-is-active">Aktiv</label>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Conditions -->
                    <h6>Bedingungen</h6>
                    <div class="mb-3">
                        <label for="rule-match-mode" class="form-label">Match-Modus</label>
                        <select class="form-select" id="rule-match-mode">
                            <option value="all">Alle Bedingungen (AND)</option>
                            <option value="any">Mindestens eine (OR)</option>
                        </select>
                    </div>
                    
                    <!-- Absender -->
                    <div class="mb-3">
                        <label class="form-label">Absender</label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <select class="form-select" id="rule-sender-operator">
                                    <option value="">-- nicht prüfen --</option>
                                    <option value="contains">enthält</option>
                                    <option value="not_contains">enthält nicht</option>
                                    <option value="equals">ist genau</option>
                                    <option value="domain">Domain ist</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="rule-sender-value" 
                                       placeholder="z.B. newsletter oder @example.com">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Betreff -->
                    <div class="mb-3">
                        <label class="form-label">Betreff</label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <select class="form-select" id="rule-subject-operator">
                                    <option value="">-- nicht prüfen --</option>
                                    <option value="contains">enthält</option>
                                    <option value="not_contains">enthält nicht</option>
                                    <option value="equals">ist genau</option>
                                    <option value="regex">RegEx-Match</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="rule-subject-value" 
                                       placeholder="z.B. Newsletter">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Body -->
                    <div class="mb-3">
                        <label class="form-label">Body/Text</label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <select class="form-select" id="rule-body-operator">
                                    <option value="">-- nicht prüfen --</option>
                                    <option value="contains">enthält</option>
                                    <option value="not_contains">enthält nicht</option>
                                    <option value="regex">RegEx-Match</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="rule-body-value" 
                                       placeholder="z.B. unsubscribe">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="rule-has-attachment">
                        <label class="form-check-label" for="rule-has-attachment">
                            Nur E-Mails mit Anhang
                        </label>
                    </div>
                    
                    <!-- Neue Bedingung: Hat bereits Tag -->
                    <div class="mb-3">
                        <label class="form-label">Hat bereits Tag</label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <select class="form-select" id="rule-tag-operator">
                                    <option value="">-- nicht prüfen --</option>
                                    <option value="has">hat dieses Tag</option>
                                    <option value="not_has">hat dieses Tag NICHT</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <select class="form-select" id="rule-tag-value">
                                    <option value="">-- Tag wählen --</option>
                                </select>
                                <small class="text-muted">Nützlich für Regel-Ketten</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Neue Bedingung: KI-Vorschlag -->
                    <div class="mb-3">
                        <label class="form-label">KI schlägt Tag vor</label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <select class="form-select" id="rule-ai-tag-operator">
                                    <option value="">-- nicht prüfen --</option>
                                    <option value="suggests">schlägt vor</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="rule-ai-tag-value">
                                    <option value="">-- Tag wählen --</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control" id="rule-ai-confidence" 
                                       placeholder="Confidence %" min="50" max="100" step="5" value="85">
                                <small class="text-muted">Min. Sicherheit (50-100%)</small>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-info-circle"></i> Nutzt Smart Tag Suggestions (Phase F.2)
                        </small>
                    </div>
                    
                    <hr>
                    
                    <!-- Actions -->
                    <h6>Aktionen</h6>
                    
                    <div class="mb-3">
                        <label for="rule-move-to" class="form-label">Verschieben nach</label>
                        <select class="form-select" id="rule-move-to">
                            <option value="">-- Kein Verschieben --</option>
                            <!-- Wird dynamisch gefüllt -->
                        </select>
                        <small class="text-muted">Ordner werden von Ihrem IMAP-Account geladen</small>
                    </div>
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="rule-mark-read">
                        <label class="form-check-label" for="rule-mark-read">
                            Als gelesen markieren
                        </label>
                    </div>
                    
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="rule-mark-flagged">
                        <label class="form-check-label" for="rule-mark-flagged">
                            Als wichtig markieren (Flag)
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label for="rule-apply-tag" class="form-label">Tag zuweisen</label>
                        <select class="form-select" id="rule-apply-tag">
                            <option value="">-- Kein Tag --</option>
                            <!-- Wird dynamisch gefüllt -->
                        </select>
                        <small class="text-muted">Tags von Ihrer Tag-Verwaltung. Neues Tag? → Erst in Tag-Verwaltung erstellen</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="rule-stop-processing">
                        <label class="form-check-label" for="rule-stop-processing">
                            Nach dieser Regel stoppen
                        </label>
                        <small class="form-text text-muted d-block ms-4">
                            ℹ️ Wenn aktiviert: Keine weiteren Regeln werden nach dieser ausgeführt (z.B. bei Spam → direkt löschen, danach keine Archive-Regel mehr)
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="btn-save-rule">Speichern</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Test Results -->
<div class="modal fade" id="modal-test-results" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Regel-Test Ergebnisse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="test-results-content"></div>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce }}">
// Phase G.2: Auto-Rules Management JavaScript

const RulesManager = {
    folders: [],
    tags: [],
    isLoading: false,
    
    async init() {
        this.isLoading = true;
        await this.loadFoldersAndTags();
        this.isLoading = false;
        this.bindEvents();
        this.loadTemplates();
    },
    
    async loadFoldersAndTags() {
        // Load Folders
        try {
            const accountsResp = await fetch('/api/accounts');
            const accountsData = await accountsResp.json();
            if (accountsData.accounts && accountsData.accounts.length > 0) {
                const accountId = accountsData.accounts[0].id;
                const foldersResp = await fetch(`/account/${accountId}/folders`);
                const foldersData = await foldersResp.json();
                this.folders = foldersData.folders || [];
            }
        } catch (error) {
            console.error('Fehler beim Laden der Ordner:', error);
        }
        
        // Load Tags
        try {
            const tagsResp = await fetch('/api/tags');
            if (tagsResp.ok) {
                const tagsData = await tagsResp.json();
                // API gibt direkt Array zurück: [{id, name, color}, ...]
                this.tags = Array.isArray(tagsData) ? tagsData : [];
                console.log('✅ Tags geladen:', this.tags.length);
            }
        } catch (error) {
            console.error('Fehler beim Laden der Tags:', error);
        }
    },
    
    populateFolderSelect() {
        const select = document.getElementById('rule-move-to');
        select.innerHTML = '<option value="">-- Kein Verschieben --</option>';
        this.folders.forEach(folder => {
            const option = document.createElement('option');
            option.value = folder;
            option.textContent = folder;
            select.appendChild(option);
        });
    },
    
    populateTagSelect() {
        const selects = [
            document.getElementById('rule-apply-tag'),      // Action: Tag zuweisen
            document.getElementById('rule-tag-value'),      // Condition: Hat Tag
            document.getElementById('rule-ai-tag-value')    // Condition: KI schlägt vor
        ];
        
        console.log('📋 populateTagSelect aufgerufen, Tags:', this.tags.length, this.tags);
        
        selects.forEach(select => {
            if (!select) return;
            
            const isActionSelect = select.id === 'rule-apply-tag';
            const defaultOption = isActionSelect ? '-- Kein Tag --' : '-- Tag wählen --';
            
            select.innerHTML = `<option value="">${defaultOption}</option>`;
            
            this.tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.name;
                // Zeige Farbe als Emoji-Kreis + Name
                const colorEmoji = getColorEmoji(tag.color || '');
                option.textContent = `${colorEmoji} ${tag.name}`;
                // Füge data-color für CSS-Styling hinzu
                option.setAttribute('data-color', tag.color || 'gray');
                select.appendChild(option);
            });
        });
        
        console.log('✅ Tag-Dropdowns befüllt:', selects.filter(s => s).length, 'Selects');
    },
    
    bindEvents() {
        // Create Rule
        document.getElementById('btn-create-rule')?.addEventListener('click', () => this.openRuleEditor());
        document.getElementById('btn-create-first-rule')?.addEventListener('click', () => this.openRuleEditor());
        
        // Template-based creation
        document.getElementById('btn-create-from-template')?.addEventListener('click', () => {
            document.querySelector('#templates-list').scrollIntoView({ behavior: 'smooth' });
        });
        
        // Save Rule
        document.getElementById('btn-save-rule')?.addEventListener('click', () => this.saveRule());
        
        // Apply Rules
        document.getElementById('btn-apply-rules')?.addEventListener('click', () => this.applyRules());
        
        // Test/Edit/Delete buttons
        document.querySelectorAll('.btn-test-rule').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const ruleId = e.target.closest('button').dataset.ruleId;
                this.testRule(ruleId);
            });
        });
        
        document.querySelectorAll('.btn-edit-rule').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const ruleId = e.target.closest('button').dataset.ruleId;
                this.editRule(ruleId);
            });
        });
        
        document.querySelectorAll('.btn-delete-rule').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const ruleId = e.target.closest('button').dataset.ruleId;
                this.deleteRule(ruleId);
            });
        });
    },
    
    async loadTemplates() {
        try {
            const response = await fetch('/api/rules/templates');
            const data = await response.json();
            
            const container = document.getElementById('templates-list');
            container.innerHTML = data.templates.map(template => `
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${template.name}</h6>
                            <p class="card-text small text-muted">${template.description}</p>
                            <button class="btn btn-sm btn-primary btn-use-template" 
                                    data-template-id="${template.id}">
                                <i class="bi bi-plus"></i> Verwenden
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Bind template buttons
            document.querySelectorAll('.btn-use-template').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const templateId = e.target.closest('button').dataset.templateId;
                    this.createFromTemplate(templateId);
                });
            });
            
        } catch (error) {
            console.error('Failed to load templates:', error);
        }
    },
    
    openRuleEditor(ruleData = null) {
        // Populate Selects
        this.populateFolderSelect();
        this.populateTagSelect();
        
        const modal = new bootstrap.Modal(document.getElementById('modal-rule-editor'));
        
        if (ruleData) {
            // Edit mode
            document.getElementById('rule-id').value = ruleData.id;
            document.getElementById('rule-name').value = ruleData.name;
            document.getElementById('rule-description').value = ruleData.description || '';
            document.getElementById('rule-priority').value = ruleData.priority;
            document.getElementById('rule-is-active').checked = ruleData.is_active;
            
            // Conditions
            const conditions = ruleData.conditions || {};
            document.getElementById('rule-match-mode').value = conditions.match_mode || 'all';
            
            // Sender - Map alte Felder auf neue Operatoren
            if (conditions.sender_contains) {
                document.getElementById('rule-sender-operator').value = 'contains';
                document.getElementById('rule-sender-value').value = conditions.sender_contains;
            } else if (conditions.sender_not_contains) {
                document.getElementById('rule-sender-operator').value = 'not_contains';
                document.getElementById('rule-sender-value').value = conditions.sender_not_contains;
            } else if (conditions.sender_equals) {
                document.getElementById('rule-sender-operator').value = 'equals';
                document.getElementById('rule-sender-value').value = conditions.sender_equals;
            } else if (conditions.sender_domain) {
                document.getElementById('rule-sender-operator').value = 'domain';
                document.getElementById('rule-sender-value').value = conditions.sender_domain;
            }
            
            // Subject
            if (conditions.subject_contains) {
                document.getElementById('rule-subject-operator').value = 'contains';
                document.getElementById('rule-subject-value').value = conditions.subject_contains;
            } else if (conditions.subject_not_contains) {
                document.getElementById('rule-subject-operator').value = 'not_contains';
                document.getElementById('rule-subject-value').value = conditions.subject_not_contains;
            } else if (conditions.subject_equals) {
                document.getElementById('rule-subject-operator').value = 'equals';
                document.getElementById('rule-subject-value').value = conditions.subject_equals;
            } else if (conditions.subject_regex) {
                document.getElementById('rule-subject-operator').value = 'regex';
                document.getElementById('rule-subject-value').value = conditions.subject_regex;
            }
            
            // Body
            if (conditions.body_contains) {
                document.getElementById('rule-body-operator').value = 'contains';
                document.getElementById('rule-body-value').value = conditions.body_contains;
            } else if (conditions.body_not_contains) {
                document.getElementById('rule-body-operator').value = 'not_contains';
                document.getElementById('rule-body-value').value = conditions.body_not_contains;
            } else if (conditions.body_regex) {
                document.getElementById('rule-body-operator').value = 'regex';
                document.getElementById('rule-body-value').value = conditions.body_regex;
            }
            
            document.getElementById('rule-has-attachment').checked = conditions.has_attachment || false;
            
            // Tag-Bedingung (neu)
            if (conditions.has_tag) {
                document.getElementById('rule-tag-operator').value = 'has';
                document.getElementById('rule-tag-value').value = conditions.has_tag;
            } else if (conditions.not_has_tag) {
                document.getElementById('rule-tag-operator').value = 'not_has';
                document.getElementById('rule-tag-value').value = conditions.not_has_tag;
            }
            
            // KI-Suggested-Tag (neu)
            if (conditions.ai_suggested_tag) {
                document.getElementById('rule-ai-tag-operator').value = 'suggests';
                document.getElementById('rule-ai-tag-value').value = conditions.ai_suggested_tag;
                document.getElementById('rule-ai-confidence').value = conditions.ai_confidence_threshold || 85;
            }
            
            // Actions
            const actions = ruleData.actions || {};
            document.getElementById('rule-move-to').value = actions.move_to_folder || '';
            document.getElementById('rule-mark-read').checked = actions.mark_as_read || false;
            document.getElementById('rule-mark-flagged').checked = actions.mark_as_flagged || false;
            document.getElementById('rule-apply-tag').value = actions.apply_tag || '';
            document.getElementById('rule-stop-processing').checked = actions.stop_processing || false;
        } else {
            // Create mode - reset form
            document.getElementById('form-rule-editor').reset();
            document.getElementById('rule-id').value = '';
            document.getElementById('rule-is-active').checked = true;
        }
        
        modal.show();
    },
    
    async saveRule() {
        const ruleId = document.getElementById('rule-id').value;
        const isEdit = ruleId !== '';
        
        // Collect form data
        const conditions = {};
        const actions = {};
        
        // Conditions
        const matchMode = document.getElementById('rule-match-mode').value;
        if (matchMode) conditions.match_mode = matchMode;
        
        // Sender - Map Operator + Value to backend fields
        const senderOp = document.getElementById('rule-sender-operator').value;
        const senderVal = document.getElementById('rule-sender-value').value.trim();
        if (senderOp && senderVal) {
            if (senderOp === 'contains') {
                conditions.sender_contains = senderVal;
            } else if (senderOp === 'equals') {
                conditions.sender_equals = senderVal;
            } else if (senderOp === 'domain') {
                conditions.sender_domain = senderVal;
            } else if (senderOp === 'not_contains') {
                conditions.sender_not_contains = senderVal;
            }
        }
        
        // Subject
        const subjectOp = document.getElementById('rule-subject-operator').value;
        const subjectVal = document.getElementById('rule-subject-value').value.trim();
        if (subjectOp && subjectVal) {
            if (subjectOp === 'contains') {
                conditions.subject_contains = subjectVal;
            } else if (subjectOp === 'regex') {
                conditions.subject_regex = subjectVal;
            } else if (subjectOp === 'equals') {
                conditions.subject_equals = subjectVal;
            } else if (subjectOp === 'not_contains') {
                conditions.subject_not_contains = subjectVal;
            }
        }
        
        // Body
        const bodyOp = document.getElementById('rule-body-operator').value;
        const bodyVal = document.getElementById('rule-body-value').value.trim();
        if (bodyOp && bodyVal) {
            if (bodyOp === 'contains') {
                conditions.body_contains = bodyVal;
            } else if (bodyOp === 'regex') {
                conditions.body_regex = bodyVal;
            } else if (bodyOp === 'not_contains') {
                conditions.body_not_contains = bodyVal;
            }
        }
        
        const hasAttachment = document.getElementById('rule-has-attachment').checked;
        if (hasAttachment) conditions.has_attachment = true;
        
        // Tag-Bedingung (neu)
        const tagOp = document.getElementById('rule-tag-operator').value;
        const tagVal = document.getElementById('rule-tag-value').value.trim();
        if (tagOp && tagVal) {
            if (tagOp === 'has') {
                conditions.has_tag = tagVal;
            } else if (tagOp === 'not_has') {
                conditions.not_has_tag = tagVal;
            }
        }
        
        // KI-Suggested-Tag Bedingung (neu)
        const aiTagOp = document.getElementById('rule-ai-tag-operator').value;
        const aiTagVal = document.getElementById('rule-ai-tag-value').value.trim();
        const aiConfidence = parseInt(document.getElementById('rule-ai-confidence').value) || 85;
        if (aiTagOp === 'suggests' && aiTagVal) {
            conditions.ai_suggested_tag = aiTagVal;
            conditions.ai_confidence_threshold = aiConfidence;
        }
        
        // Actions
        const moveTo = document.getElementById('rule-move-to').value.trim();
        if (moveTo) actions.move_to_folder = moveTo;
        
        if (document.getElementById('rule-mark-read').checked) {
            actions.mark_as_read = true;
        }
        
        if (document.getElementById('rule-mark-flagged').checked) {
            actions.mark_as_flagged = true;
        }
        
        const applyTag = document.getElementById('rule-apply-tag').value.trim();
        if (applyTag) actions.apply_tag = applyTag;
        
        if (document.getElementById('rule-stop-processing').checked) {
            actions.stop_processing = true;
        }
        
        const ruleData = {
            name: document.getElementById('rule-name').value.trim(),
            description: document.getElementById('rule-description').value.trim(),
            priority: parseInt(document.getElementById('rule-priority').value),
            is_active: document.getElementById('rule-is-active').checked,
            conditions: conditions,
            actions: actions
        };
        
        try {
            const url = isEdit ? `/api/rules/${ruleId}` : '/api/rules';
            const method = isEdit ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content
                },
                body: JSON.stringify(ruleData)
            });
            
            if (response.ok) {
                alert(isEdit ? 'Regel aktualisiert!' : 'Regel erstellt!');
                window.location.reload();
            } else {
                const error = await response.json();
                alert('Fehler: ' + (error.error || 'Unbekannter Fehler'));
            }
        } catch (error) {
            console.error('Save rule failed:', error);
            alert('Fehler beim Speichern der Regel');
        }
    },
    
    async editRule(ruleId) {
        try {
            const response = await fetch('/api/rules');
            const data = await response.json();
            const rule = data.rules.find(r => r.id == ruleId);
            
            if (rule) {
                this.openRuleEditor(rule);
            }
        } catch (error) {
            console.error('Load rule failed:', error);
        }
    },
    
    async deleteRule(ruleId) {
        if (!confirm('Regel wirklich löschen?')) return;
        
        try {
            const response = await fetch(`/api/rules/${ruleId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content
                }
            });
            
            if (response.ok) {
                alert('Regel gelöscht!');
                window.location.reload();
            }
        } catch (error) {
            console.error('Delete rule failed:', error);
            alert('Fehler beim Löschen');
        }
    },
    
    async testRule(ruleId) {
        try {
            const response = await fetch(`/api/rules/${ruleId}/test`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content
                },
                body: JSON.stringify({})
            });
            
            const data = await response.json();
            
            const modal = new bootstrap.Modal(document.getElementById('modal-test-results'));
            const content = document.getElementById('test-results-content');
            
            content.innerHTML = `
                <div class="alert alert-info">
                    <strong>Regel:</strong> ${data.rule_name}<br>
                    <strong>Getestet:</strong> ${data.total_tested} E-Mail(s)<br>
                    <strong>Matches:</strong> ${data.total_matches}
                </div>
                ${data.matches.length > 0 ? `
                    <h6>Würde auf folgende E-Mails angewendet werden:</h6>
                    <ul>
                        ${data.matches.map(m => `
                            <li>E-Mail ID ${m.email_id}: ${m.actions_would_execute.join(', ')}</li>
                        `).join('')}
                    </ul>
                ` : '<p class="text-muted">Keine Matches gefunden.</p>'}
            `;
            
            modal.show();
        } catch (error) {
            console.error('Test rule failed:', error);
            alert('Fehler beim Testen');
        }
    },
    
    async applyRules() {
        if (!confirm('Regeln auf alle unverarbeiteten E-Mails anwenden?')) return;
        
        try {
            const response = await fetch('/api/rules/apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content
                },
                body: JSON.stringify({})
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(`✅ Regeln angewendet!\n\n` +
                      `E-Mails: ${data.stats.emails_processed}\n` +
                      `Regeln ausgelöst: ${data.stats.rules_triggered}\n` +
                      `Aktionen: ${data.stats.actions_executed}`);
                window.location.reload();
            }
        } catch (error) {
            console.error('Apply rules failed:', error);
            alert('Fehler beim Anwenden');
        }
    },
    
    async createFromTemplate(templateId) {
        try {
            const response = await fetch(`/api/rules/templates/${templateId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content
                },
                body: JSON.stringify({})
            });
            
            if (response.ok) {
                alert('Regel aus Template erstellt!');
                window.location.reload();
            }
        } catch (error) {
            console.error('Create from template failed:', error);
            alert('Fehler beim Erstellen');
        }
    }
};

// Helper: Color Indicator (wie in email_detail.html)
function getColorIndicator(color) {
    const colorMap = {
        'red': '#dc3545',
        'blue': '#0d6efd',
        'green': '#198754',
        'yellow': '#ffc107',
        'orange': '#fd7e14',
        'purple': '#6f42c1',
        'pink': '#d63384',
        'brown': '#8b4513',
        'gray': '#6c757d',
        'cyan': '#0dcaf0'
    };
    const hexColor = colorMap[color?.toLowerCase()] || '#6c757d';
    return `<span class="tag-color-indicator" style="background-color: ${hexColor};"></span>`;
}

// Legacy function für Kompatibilität
function getColorEmoji(color) {
    const colorMap = {
        'red': '🔴',
        'blue': '🔵',
        'green': '🟢',
        'yellow': '🟡',
        'orange': '🟠',
        'purple': '🟣',
        'pink': '🩷',
        'brown': '🟤',
        'gray': '⚫',
        'cyan': '🔵'
    };
    return colorMap[color?.toLowerCase()] || '⚪';
}

// Initialize
document.addEventListener('DOMContentLoaded', () => RulesManager.init());
</script>
{% endblock %}
